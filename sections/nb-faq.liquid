{%- comment -%}
  NB — FAQ (Global)
  - Blocks-based FAQ UI (details/summary)
  - JSON-LD (FAQPage) emitter, gated by section setting
  - Auto-suppresses JSON-LD on Coaching Service pages (those emit their own)
{%- endcomment -%}

{%- comment -%} Detect service pages to avoid duplicate FAQ JSON-LD {%- endcomment -%}
{%- assign nb_is_service_page = false -%}
{%- if template contains 'coaching-service' or template contains 'coaching_service' or template contains 'page.coaching' -%}
  {%- assign nb_is_service_page = true -%}
{%- endif -%}
{%- if page and page.metafields.coachingservice.coaching_service -%}
  {%- assign nb_is_service_page = true -%}
{%- endif -%}
{%- if page and page.metafields.custom.coaching_service -%}
  {%- assign nb_is_service_page = true -%}
{%- endif -%}

{%- liquid
  assign title       = section.settings.title | default: 'Frequently asked questions'
  assign width       = section.settings.width | default: 'normal'
  assign wrap_shell  = section.settings.wrap_shell
  assign single_open = section.settings.single_open

  assign col_ink     = section.settings.ink       | default: '#223238'
  assign col_teal    = section.settings.teal      | default: '#0F5B59'
  assign col_shell   = section.settings.shell_col | default: '#E5E8E1'
  assign col_answer  = section.settings.answer    | default: '#EAF4F3'
endliquid -%}

{%- liquid
  assign width_class = 'nb-shell'
  if width == 'narrow'
    assign width_class = 'nb-shell nb-shell--narrow'
  endif
  if width == 'wide'
    assign width_class = 'nb-shell nb-shell--wide'
  endif
-%}

<section id="nb-faq-{{ section.id }}"
         class="nb-faq-section{% if wrap_shell %} nb-faq--tray{% endif %}"
         style="--nb-faq-ink: {{ col_ink }}; --nb-faq-teal: {{ col_teal }}; --nb-faq-shell: {{ col_shell }}; --nb-faq-answer: {{ col_answer }};">

  <div class="{{ width_class }}">
    <div class="nb-faq__wrap{% if wrap_shell %} nb-faq__wrap--tray{% endif %}">
      {%- if title != blank -%}
        <h2 class="nb-faq__title">{{ title }}</h2>
      {%- endif -%}

      <div class="nb-faq__list" {% if single_open %}data-single-open="true"{% endif %}>
        {%- for b in section.blocks -%}
          {%- assign q = b.settings.q | to_s | strip -%}
          {%- assign a = b.settings.a | to_s | strip -%}
          {%- if q != blank -%}
            <details class="nb-faq__item" {% if b.settings.open %}open{% endif %}>
              <summary class="nb-faq__q">{{ q }}</summary>
              {%- if a != blank -%}
                <div class="nb-faq__a rte">{{ a }}</div>
              {%- endif -%}
            </details>
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>
  </div>
</section>

<style>
  .nb-shell{ max-width:min(1160px,94vw); margin-inline:auto; padding-inline:20px; }
  .nb-shell.nb-shell--narrow{ max-width:min(900px,92vw); }
  .nb-shell.nb-shell--wide{ max-width:min(1320px,96vw); }

  .nb-faq-section{ color: var(--nb-faq-ink, #223238); }
  .nb-faq__wrap{ margin: 12px 0; }
  .nb-faq__wrap--tray{
    background: var(--nb-faq-shell, #E5E8E1);
    border-radius: 22px;
    padding: clamp(16px, 2.6vw, 28px);
    box-shadow: 0 10px 24px rgba(0,0,0,.06);
  }

  .nb-faq__title{
    margin: 0 0 clamp(10px, 2vw, 16px);
    text-align: center;
    font-weight: 800;
    color: var(--nb-faq-ink, #223238);
    font-family: var(--font-heading-family, inherit);
    font-size: clamp(22px, 2.8vw, 28px);
  }

  .nb-faq__list{ display: grid; gap: 18px; }
  .nb-faq__item{
    background: transparent;
    border: 0;
    box-shadow: none;
    overflow: visible;
  }
  .nb-faq__q{
    position: relative;
    background: var(--nb-faq-teal, #0F5B59);
    color: #fff;
    border: 0;
    border-radius: 9999px;
    padding: 16px 64px 16px 22px;
    font-weight: 720;
    box-shadow: 0 4px 14px rgba(0,0,0,.05);
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    list-style: none;
    cursor: pointer;
    font-family: var(--font-body-family, inherit);
  }
  .nb-faq__q::-webkit-details-marker{ display:none; }
  .nb-faq__q:hover{ background: color-mix(in oklab, var(--nb-faq-teal, #0F5B59), #000 8%); }
  .nb-faq__q::after{
    content: "+";
    position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
    width: 38px; height: 38px; border-radius: 999px;
    display: grid; place-items: center;
    color: #fff; background: rgba(255,255,255,.14);
    font-size: 22px; font-weight: 800; line-height: 1;
  }
  details[open] .nb-faq__q::after{ content: "–"; }

  .nb-faq__a{
    background: #fff;
    border: 1px solid rgba(0,0,0,.06);
    border-radius: 14px;
    margin: 10px 14px 2px;
    padding: 16px 20px;
    color: color-mix(in oklab, var(--nb-faq-ink, #223238), #000 8%);
    line-height: 1.65;
  }
</style>

{%- if section.settings.single_open -%}
<script>
  (function(){
    var root = document.querySelector('#nb-faq-{{ section.id }} .nb-faq__list[data-single-open="true"]');
    if(!root) return;
    root.addEventListener('toggle', function(ev){
      var d = ev.target;
      if(d.tagName !== 'DETAILS' || !d.open) return;
      root.querySelectorAll('details[open]').forEach(function(o){ if(o!==d) o.open=false; });
    }, true);
  })();
</script>
{%- endif -%}

{%- comment -%} JSON-LD (emits only when allowed and not on service pages) {%- endcomment -%}
{%- if section.settings.emit_jsonld and section.blocks.size > 0 and nb_is_service_page == false -%}
  {%- assign any = false -%}
  {%- for b in section.blocks -%}
    {%- assign q = b.settings.q | to_s | strip -%}
    {%- assign a = b.settings.a | to_s | strip -%}
    {%- if q != blank and a != blank -%}{%- assign any = true -%}{%- break -%}{%- endif -%}
  {%- endfor -%}
  {%- if any -%}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {%- assign first = true -%}
        {%- for b in section.blocks -%}
          {%- assign q = b.settings.q | to_s | strip -%}
          {%- assign a_html = b.settings.a | to_s | strip -%}
          {%- if q != blank and a_html != blank -%}
            {%- unless first -%},{%- endunless -%}
            {
              "@type": "Question",
              "name": {{ q | json }},
              "acceptedAnswer": { "@type": "Answer", "text": {{ a_html | json }} }
            }
            {%- assign first = false -%}
          {%- endif -%}
        {%- endfor -%}
      ]
    }
    </script>
  {%- endif -%}
{%- endif -%}

{% schema %}
{
  "name": "NB — FAQ (Global)",
  "tag": "section",
  "class": "nb-faq-section",
  "settings": [
    { "type": "text", "id": "title", "label": "Title", "default": "Frequently asked questions" },
    {
      "type": "select", "id": "width", "label": "Content width", "default": "normal",
      "options": [
        { "value": "narrow", "label": "Narrow" },
        { "value": "normal", "label": "Normal" },
        { "value": "wide",   "label": "Wide" }
      ]
    },
    { "type": "checkbox", "id": "wrap_shell", "label": "Wrap in soft tray background", "default": true },
    { "type": "checkbox", "id": "single_open", "label": "Only one item open at a time", "default": true },

    { "type": "header", "content": "Colours (optional overrides)" },
    { "type": "color", "id": "ink",       "label": "Ink (text)",             "default": "#223238" },
    { "type": "color", "id": "teal",      "label": "Teal (pill)",             "default": "#0F5B59" },
    { "type": "color", "id": "shell_col", "label": "Tray / shell background", "default": "#E5E8E1" },
    { "type": "color", "id": "answer",    "label": "Answer background",       "default": "#EAF4F3" },

    { "type": "header", "content": "SEO" },
    { "type": "checkbox", "id": "emit_jsonld", "label": "Output FAQ JSON-LD structured data", "default": true }
  ],
  "blocks": [
    {
      "type": "item",
      "name": "FAQ item",
      "settings": [
        { "type": "text",     "id": "q",    "label": "Question", "default": "Your question here" },
        { "type": "richtext", "id": "a",    "label": "Answer",   "default": "<p>Your answer text goes here.</p>" },
        { "type": "checkbox", "id": "open", "label": "Open by default", "default": false }
      ]
    }
  ],
  "max_blocks": 20,
  "presets": [
    {
      "name": "NB — FAQ (Global)",
      "category": "Text",
      "blocks": [
        { "type": "item", "settings": { "q": "What’s included?",      "a": "<p>Answer example.</p>" } },
        { "type": "item", "settings": { "q": "How long is the call?", "a": "<p>Answer example.</p>" } }
      ]
    }
  ]
}
{% endschema %}

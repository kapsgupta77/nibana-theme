{%- comment -%}
Testimonials slider — horizontal carousel
Source: Manual blocks (default) or Metaobject `nb_testimonial`
Filters: section.settings.filter_tags (CSV; case-insensitive). If "-" or empty, no filtering.
Renders each item via snippet 'nb-testimonial-card'
{%- endcomment -%}

{%- liquid
  assign heading   = section.settings.heading | default: 'What clients say'
  assign source    = section.settings.source  | default: 'blocks'
  assign limit     = section.settings.limit   | default: 6
  assign cta_label = section.settings.cta_label | default: 'View all'
  assign cta_link  = section.settings.cta_link  | default: '/'

  assign filter_raw = section.settings.filter_tags | default: '-' 
  assign filter_csv = filter_raw | replace: ';', ',' | replace: ' ,', ',' | replace: ', ', ',' 
  assign filters    = filter_csv | split: ','

  assign use_filter = false
  if filters.size > 0 and filters.first != '-' and filters.first != ''
    assign use_filter = true
  endif
-%}

<section id="nb-ts-{{ section.id }}" class="nb-tcarousel color-{{ section.settings.color_scheme }}">
  <div class="nb-shell">
    <div class="nb-tcarousel__head">
      <h2 class="nb-h3 nb-section-title">{{ heading }}</h2>
      <div class="nb-tcarousel__nav">
        <button class="nb-tcarousel__btn" type="button" aria-label="Previous" data-prev>
          &lsaquo;
        </button>
        <button class="nb-tcarousel__btn" type="button" aria-label="Next" data-next>
          &rsaquo;
        </button>
        {%- if cta_label != blank and cta_link != blank -%}
          <a class="nb-link-pill" href="{{ cta_link }}">{{ cta_label }}</a>
        {%- endif -%}
      </div>
    </div>

    <div class="nb-tcarousel__track" data-track>
      {%- if source == 'metaobject' -%}
        {%- assign mo = shop.metaobjects['nb_testimonial'] -%}
        {%- if mo and mo.values and mo.values.size > 0 -%}
          {%- assign shown = 0 -%}
          {%- for m in mo.values -%}
            {%- if shown >= limit -%}{%- break -%}{%- endif -%}
            {%- assign q   = m.quote    | default: '' -%}
            {%- assign n   = m.name     | default: '' -%}
            {%- assign tt  = m.title    | default: '' -%}
            {%- assign loc = m.location | default: '' -%}
            {%- assign av  = m.avatar -%}
            {%- assign tg  = m.tags | join: ',' | default: '' -%}

            {%- assign include = true -%}
            {%- if use_filter -%}
              {%- assign include = false -%}
              {%- assign tg_norm = tg | downcase -%}
              {%- for f in filters -%}
                {%- assign ff = f | strip | downcase -%}
                {%- if ff != '' and tg_norm contains ff -%}
                  {%- assign include = true -%}{%- break -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}

            {%- if include -%}
              <div class="nb-tcarousel__slide">
                {% render 'nb-testimonial-card',
                  quote: q, name: n, title: tt, location: loc, avatar: av, tags: tg %}
              </div>
              {%- assign shown = shown | plus: 1 -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- else -%}
        {%- assign shown = 0 -%}
        {%- for block in section.blocks -%}
          {%- if shown >= limit -%}{%- break -%}{%- endif -%}
          {%- assign q   = block.settings.quote    | default: '' -%}
          {%- assign n   = block.settings.name     | default: '' -%}
          {%- assign tt  = block.settings.title    | default: '' -%}
          {%- assign loc = block.settings.location | default: '' -%}
          {%- assign av  = block.settings.avatar -%}
          {%- assign tg  = block.settings.tags     | default: '' -%}

          {%- assign include = true -%}
          {%- if use_filter -%}
            {%- assign include = false -%}
            {%- assign tg_norm = tg | downcase -%}
            {%- for f in filters -%}
              {%- assign ff = f | strip | downcase -%}
              {%- if ff != '' and tg_norm contains ff -%}
                {%- assign include = true -%}{%- break -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}

          {%- if include -%}
            <div class="nb-tcarousel__slide" {{ block.shopify_attributes }}>
              {% render 'nb-testimonial-card',
                quote: q, name: n, title: tt, location: loc, avatar: av, tags: tg %}
            </div>
            {%- assign shown = shown | plus: 1 -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    </div>
  </div>
</section>

{% stylesheet %}
.nb-tcarousel{ --t-gap: clamp(14px,2.0vw,20px); }
.nb-tcarousel .nb-shell{ max-width: var(--page-width, 1200px); margin: 0 auto; padding: 0 var(--page-margin, 20px); }
.nb-tcarousel__head{
  display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin-bottom:10px;
}
.nb-tcarousel__nav{ display:flex; gap:8px; align-items:center; margin-left:auto; }
.nb-tcarousel__btn{
  width:36px; height:36px; border-radius:999px; border:1px solid #e9ecef;
  background:#fff; cursor:pointer; box-shadow:0 8px 18px rgba(0,0,0,.06);
}
.nb-tcarousel__btn[disabled]{ opacity:.35; cursor:default; }
.nb-link-pill{ padding:.5rem .8rem; border-radius:999px; border:1px solid #e9ecef; background:#fff; text-decoration:none; }

.nb-tcarousel__track{
  display:grid; grid-auto-flow:column; grid-auto-columns:minmax(min(320px, 86vw), 1fr);
  gap:var(--t-gap); overflow:auto; scroll-snap-type:x mandatory; padding:6px 2px 10px;
  scrollbar-width:none;
}
.nb-tcarousel__track::-webkit-scrollbar{ display:none; }
.nb-tcarousel__slide{ scroll-snap-align:start; }
@media (min-width: 900px){
  .nb-tcarousel__track{ grid-auto-columns: minmax(360px, 1fr); }
}
{% endstylesheet %}

{% javascript %}
(() => {
  const sec   = document.getElementById('nb-ts-{{ section.id }}');
  if (!sec) return;
  const track = sec.querySelector('[data-track]');
  const prev  = sec.querySelector('[data-prev]');
  const next  = sec.querySelector('[data-next]');

  if (!track || !prev || !next) return;

  const gap = () => {
    const cs = getComputedStyle(track);
    const g  = parseFloat(cs.columnGap || cs.gap || '0');
    return isNaN(g) ? 0 : g;
  };

  function stepWidth(){
    const slide = track.querySelector('.nb-tcarousel__slide');
    return slide ? slide.getBoundingClientRect().width + gap() : track.clientWidth;
  }

  function update(){
    const canScroll = track.scrollWidth > track.clientWidth + 4;
    prev.style.display = next.style.display = canScroll ? '' : 'none';
    prev.disabled = track.scrollLeft <= 0;
    next.disabled = track.scrollLeft + track.clientWidth >= track.scrollWidth - 2;
  }

  function go(dir){
    track.scrollBy({ left: dir * stepWidth(), behavior: 'smooth' });
  }

  prev.addEventListener('click', () => go(-1));
  next.addEventListener('click', () => go( 1));
  track.addEventListener('scroll', update, { passive: true });
  window.addEventListener('resize', update);
  requestAnimationFrame(update);
})();
{% endjavascript %}

{% schema %}
{
  "name": "Testimonials slider",
  "class": "section-wrapper",
  "settings": [
    { "type": "text",  "id": "heading",     "label": "Heading", "default": "What clients say" },
    { "type": "text",  "id": "filter_tags", "label": "Filter by tags (CSV)", "default": "-" },
    { "type": "select","id": "source", "label": "Source", "default": "blocks",
      "options": [
        { "value": "blocks", "label": "Manual (blocks)" },
        { "value": "metaobject", "label": "Metaobject: nb_testimonial" }
      ]
    },
    { "type": "range", "id": "limit", "label": "Max testimonials", "min": 1, "max": 24, "step": 1, "default": 6 },
    { "type": "text",  "id": "cta_label", "label": "CTA label", "default": "View all" },
    { "type": "url",   "id": "cta_link",  "label": "CTA link",  "default": "/" },
    { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme", "default": "scheme-1" },
    { "type": "header", "content": "Padding" },
    { "type": "range", "id": "padding-block-start", "label": "Top",    "min": 0, "max": 100, "step": 1, "unit": "px", "default": 0 },
    { "type": "range", "id": "padding-block-end",   "label": "Bottom", "min": 0, "max": 100, "step": 1, "unit": "px", "default": 0 }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        { "type": "textarea",     "id": "quote",    "label": "Quote", "default": "“This work helped me get clear, make braver choices, and feel more alive in daily life.”" },
        { "type": "text",         "id": "name",     "label": "Name", "default": "Client name" },
        { "type": "text",         "id": "title",    "label": "Title / descriptor", "default": "Founder" },
        { "type": "text",         "id": "location", "label": "Location", "default": "London, UK" },
        { "type": "image_picker", "id": "avatar",   "label": "Avatar (optional)" },
        { "type": "text",         "id": "tags",     "label": "Tags (optional)", "default": "-" }
      ]
    }
  ],
  "presets": [{ "name": "Testimonials slider" }]
}
{% endschema %}

{% comment %}
  Nibana – Contact Section (v2.1)
  - 2-panel layout: Info (left) + Form (right)
  - Uses global tokens from base.css:
      • Call CTA: .nb-cta (optionally add .nb-cta--xl)
      • Non-call CTA: .button
      • Panels: .nib-panel
  - Required: Name, Inquiry Purpose, Message
  - Opt-in checkbox checked by default (Theme Editor toggle)
  - Hidden customer form creates/updates Customer with tags for Mailchimp sync
{% endcomment %}

{% assign secid = 'nibana-contact--' | append: section.id %}

<section
  id="{{ secid }}"
  class="page-width color-{{ section.settings.color_scheme }}"
  style="max-width: {{ section.settings.max_width }}; margin: 0 auto; padding: {{ section.settings.section_padding }};"
  data-nb-contact="true"
  data-nb-debug="{{ section.settings.enable_debug }}"
  data-mc-enabled="{{ section.settings.use_mailchimp_flow }}"
  data-mc-action="{{ section.settings.mailchimp_action }}"
  data-shopify-customer-enabled="{{ section.settings.use_shopify_customer_flow }}"
>
<style>
    /* Scoped to this section */
    #{{ secid }} .nib-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 28px;
    }
    @media (min-width: 900px) {
      #{{ secid }} .nib-grid {
        grid-template-columns: 1.05fr 1fr;
        gap: 32px;
        align-items: start;
      }
    }
    #{{ secid }} .nib-card { 
  background: {{ section.settings.card_bg }};
  border: 1px solid {{ section.settings.card_border }};
  border-radius: {{ section.settings.card_radius }};
  /* Upgrade to luxe/3D shadow using global token (falls back to section setting) */
  box-shadow: var(--nb-shadow-2, {{ section.settings.card_shadow }});
  padding: {{ section.settings.card_padding }};
}
/* Center the left column card relative to the taller right column */
#{{ secid }} .left-panel { align-self: center; }

/* Red star for all required labels */
#{{ secid }} .nib-req { color:#b91c1c; margin-left:4px; }
    #{{ secid }} .nib-muted { opacity: .8; }
    #{{ secid }} .nib-label { display:block; margin:0 0 6px 0; font-weight: 500; }
    #{{ secid }} .nib-input, #{{ secid }} .nib-select, #{{ secid }} .nib-textarea {
      width:100%; padding:12px 14px; border:1px solid var(--color-input-border, #e5e7eb);
      border-radius: 10px; background:#fff;
    }
    #{{ secid }} .nib-help { font-size: 12px; opacity:.7; margin-top: 6px; }
    #{{ secid }} .nib-actions { display:flex; gap:12px; align-items:center; }
    #{{ secid }} .nib-form-grid { display:grid; grid-template-columns: 1fr; gap: 14px; }

#{{ secid }} .nib-card.nib-panel:hover {
  transform: translateY(-2px);
  box-shadow: 0 14px 36px rgba(0,0,0,.14);
  transition: box-shadow .2s ease, transform .12s ease;
}

    #{{ secid }} [data-nb-captcha-overlay] {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(16px, 5vw, 40px);
      background: rgba(15, 23, 42, 0.55);
      z-index: 9999;
    }
    #{{ secid }} [data-nb-captcha-overlay][hidden] {
      display: none !important;
    }
    #{{ secid }} .nb-captcha-overlay__dialog {
      position: relative;
      z-index: 1;
      background: #ffffff;
      color: #0f172a;
      width: min(640px, 100%);
      border-radius: 20px;
      box-shadow: 0 28px 64px rgba(15, 23, 42, 0.24);
      padding: clamp(20px, 4vw, 32px);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    #{{ secid }} .nb-captcha-overlay__backdrop {
      position: absolute;
      inset: 0;
      background: transparent;
    }
    #{{ secid }} .nb-captcha-overlay__header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    #{{ secid }} .nb-captcha-overlay__title {
      margin: 0;
      font-size: clamp(20px, 3vw, 26px);
      line-height: 1.3;
    }
    #{{ secid }} .nb-captcha-overlay__icon-close {
      background: none;
      border: 0;
      color: rgba(15, 23, 42, 0.55);
      font-size: 28px;
      line-height: 1;
      padding: 4px;
      cursor: pointer;
    }
    #{{ secid }} .nb-captcha-overlay__icon-close:hover,
    #{{ secid }} .nb-captcha-overlay__icon-close:focus-visible {
      color: rgba(15, 23, 42, 0.9);
      outline: none;
    }
    #{{ secid }} .nb-captcha-overlay__copy {
      margin: 0;
      font-size: 15px;
      line-height: 1.6;
      color: rgba(15, 23, 42, 0.82);
    }
    #{{ secid }} .nb-captcha-overlay__frame {
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 10px;
      background: #f8fafc;
    }
    #{{ secid }} .nb-captcha-overlay__frame iframe {
      width: 100%;
      min-height: 420px;
      border: 0;
      border-radius: 12px;
      background: #ffffff;
    }
    #{{ secid }} .nb-captcha-overlay__actions {
      display: flex;
      justify-content: flex-end;
    }
    #{{ secid }} .nb-captcha-overlay__close {
      border: none;
      background: none;
      font: inherit;
      color: #0f172a;
      cursor: pointer;
      padding: 8px 2px;
    }
    #{{ secid }} .nb-captcha-overlay__close:hover,
    #{{ secid }} .nb-captcha-overlay__close:focus-visible {
      text-decoration: underline;
      outline: none;
    }
    #{{ secid }} .nb-captcha-overlay__form {
      position: absolute;
      width: 1px;
      height: 1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
    }

  </style>

  <div class="nib-grid">
    <!-- LEFT PANEL: Info + Details + Book a Call -->
   <div class="nib-card nib-panel left-panel">
      <h1 class="{{ section.settings.heading_class }}" style="margin:0 0 6px 0;">
        {{ section.settings.heading }}
      </h1>
      <p class="{{ section.settings.subheading_class }} nib-muted" style="margin:0 0 22px 0;">
        {{ section.settings.subheading }}
      </p>

      <div style="display:grid; gap:18px;">
        <!-- Contact Details -->
        <div class="nib-card nib-panel" style="padding:16px;">
          <h3 class="{{ section.settings.block_heading_class }}" style="margin:0 0 8px 0;">{{ section.settings.details_heading }}</h3>
          <p style="margin:0;">
            <a href="mailto:{{ section.settings.details_email }}">{{ section.settings.details_email }}</a><br>
            <a href="tel:{{ section.settings.details_phone | replace: ' ', '' }}">{{ section.settings.details_phone }}</a>
          </p>
          {% if section.settings.details_note != blank %}
            <p class="nib-muted" style="margin:8px 0 0 0;">{{ section.settings.details_note }}</p>
          {% endif %}
        </div>

        <!-- Prefer to talk -->
        <div class="nib-card nib-panel" style="padding:16px;">
          <h3 class="{{ section.settings.block_heading_class }}" style="margin:0 0 8px 0;">{{ section.settings.call_heading }}</h3>
          <p class="nib-muted" style="margin:0 0 12px 0;">{{ section.settings.call_sub }}</p>
          <a href="{{ section.settings.call_link }}"
             class="{{ section.settings.cta_call_class }}"
             style="text-decoration:none;">
             {{ section.settings.call_label }}
          </a>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL: Contact Form -->
    <div class="nib-card nib-panel">
      {% form 'contact', id: 'NibanaContactForm', class: 'contact-form' %}
        {% if form.posted_successfully? %}
          <div role="status" class="nib-card nib-panel" style="padding:12px; background:#f6fff6; border-color:#d9ead3;">
            {{ section.settings.success_text }}
          </div>
        {% endif %}
        {% if form.errors %}
          <div role="alert" class="nib-card nib-panel" style="padding:12px; background:#fff5f5; border-color:#f3c2c2;">
            {{ section.settings.error_text }}
          </div>
        {% endif %}

        <div class="nib-form-grid">
          <!-- Name (required) -->
          <div>
            <label for="ContactName" class="nib-label">
  {{ section.settings.label_name }} <span class="nib-req" aria-hidden="true">*</span>
</label>
            <input id="ContactName" type="text" name="contact[name]"
                   required aria-required="true" autocapitalize="words" autocomplete="name"
                   value="{{ form.name | default: customer.name }}" class="nib-input">
          </div>

          <!-- Email (required) -->
          <div>
            <label for="ContactEmail" class="nib-label">
  {{ section.settings.label_email }} <span class="nib-req" aria-hidden="true">*</span>
</label>
            <input id="ContactEmail" type="email" name="contact[email]"
                   required aria-required="true" autocomplete="email"
                   value="{{ form.email | default: customer.email }}" class="nib-input">
          </div>

          <!-- Phone -->
          <div>
            <label for="ContactPhone" class="nib-label">{{ section.settings.label_phone }}</label>
            <input id="ContactPhone" type="tel" name="contact[phone]" autocomplete="tel" class="nib-input">
          </div>

          <!-- Inquiry Purpose (required) -->
          <div>
            <label for="InquiryPurpose" class="nib-label">
  {{ section.settings.label_purpose }} <span class="nib-req" aria-hidden="true">*</span>
</label>
{% comment %} Fallback options if no blocks exist {% endcomment %}
{% assign has_purpose_blocks = false %}
{% for block in section.blocks %}
  {% if block.type == 'purpose_option' %}
    {% assign has_purpose_blocks = true %}
    {% break %}
  {% endif %}
{% endfor %}

<select id="InquiryPurpose" name="contact[Inquiry Purpose]" required aria-required="true" class="nib-select">
  <option value="" disabled selected>{{ section.settings.purpose_placeholder }}</option>

  {% if has_purpose_blocks %}
    {% for block in section.blocks %}
      {% if block.type == 'purpose_option' %}
        <option value="{{ block.settings.option_label }}">{{ block.settings.option_label }}</option>
      {% endif %}
    {% endfor %}
  {% else %}
    {% assign defaults = "Discovery Call|Transformatioanal Life Coaching|Relationship Coaching|Executive Coaching|Speaking / Workshops|Media / Press|Other" | split: "|" %}
    {% for label in defaults %}
      <option value="{{ label }}">{{ label }}</option>
    {% endfor %}
  {% endif %}
</select>
          </div>

          <!-- Message (required) -->
          <div>
            <label for="ContactMessage" class="nib-label">
  {{ section.settings.label_message }} <span class="nib-req" aria-hidden="true">*</span>
</label>
            <textarea id="ContactMessage" name="contact[body]" rows="6" required aria-required="true" class="nib-textarea"></textarea>
          </div>

          <!-- Opt-in (checked by default; editable) -->
          <div>
            <label style="display:flex; gap:8px; align-items:center;">
              <input id="JoinEmails" type="checkbox" {% if section.settings.optin_checked %}checked{% endif %}>
              <span>{{ section.settings.optin_label }}</span>
            </label>
            <div class="nib-help">{{ section.settings.optin_help }}</div>
          </div>

          <!-- Submit -->
          <div class="nib-actions" style="margin-top: 6px;">
            <button type="submit"
        class="{{ section.settings.cta_submit_class }}"
        style="width:100%; background: var(--nb-teal, #10636c); color:#fff;">
  {{ section.settings.submit_label }}
</button>
          </div>
        </div>
      {% endform %}

  {%- comment -%}
  Hidden customer/newsletter form (creates/updates Shopify Customer) and overlay
  to surface Shopify's captcha when required.
  {%- endcomment -%}
{% if section.settings.use_shopify_customer_flow %}
  <div
    id="ShopifyCaptchaOverlay"
    class="nb-captcha-overlay"
    data-nb-captcha-overlay
    hidden
    aria-hidden="true"
  >
    <div class="nb-captcha-overlay__backdrop" data-nb-captcha-close></div>
    <div
      class="nb-captcha-overlay__dialog"
      role="dialog"
      aria-modal="true"
      aria-labelledby="{{ secid }}-captcha-title"
    >
      <div class="nb-captcha-overlay__header">
        <h2 id="{{ secid }}-captcha-title" class="nb-captcha-overlay__title" data-nb-captcha-focus tabindex="-1">
          {{ section.settings.captcha_heading | default: 'Almost there…' }}
        </h2>
        <button type="button" class="nb-captcha-overlay__icon-close" data-nb-captcha-close aria-label="Close verification">
          &times;
        </button>
      </div>
      <p class="nb-captcha-overlay__copy">
        {{ section.settings.captcha_copy | default: "Shopify sometimes asks for a quick captcha. Complete the prompt below to finish sending your message." }}
      </p>
      <div class="nb-captcha-overlay__frame" data-nb-captcha-frame>
        <iframe
          id="HiddenNewsletterFrame"
          name="HiddenNewsletterFrame"
          title="Shopify verification"
          tabindex="0"
        ></iframe>
      </div>
      <div class="nb-captcha-overlay__actions">
        <button type="button" class="nb-captcha-overlay__close" data-nb-captcha-close>
          {{ section.settings.captcha_close_label | default: 'Close' }}
        </button>
      </div>
      <div class="nb-captcha-overlay__form" aria-hidden="true">
        {% form 'customer', id: 'NibanaHiddenNewsletter', target: 'HiddenNewsletterFrame' %}
          <input type="email"   name="contact[email]"           id="HiddenCustomerEmail">
          <input type="text"    name="contact[name]"            id="HiddenCustomerName">
          <input type="text"    name="contact[first_name]"      id="HiddenCustomerFirstName">
          <input type="text"    name="contact[last_name]"       id="HiddenCustomerLastName">
          <input type="tel"     name="contact[phone]"           id="HiddenCustomerPhone">
          <input type="hidden"  name="contact[tags]"            id="HiddenCustomerTags" value="">
          <input type="hidden"  name="contact[accepts_marketing]" id="HiddenCustomerAcceptsMarketing" value="false">
          <button id="HiddenCustomerSubmit" type="submit">Submit</button>
        {% endform %}
      </div>
    </div>
  </div>
{% endif %}
    </div>
  </div>

{%- comment -%}
  Hidden Mailchimp embed form (posts to your Mailchimp audience in the background).
  Requires "mailchimp_action" setting (subscribe/post?... URL from Mailchimp Embedded form).
{%- endcomment -%}
<div aria-hidden="true" style="position:absolute; width:1px; height:1px; overflow:hidden; left:-9999px;">
  <iframe id="MailchimpFrame" name="MailchimpFrame" tabindex="-1"></iframe>
  <form id="NibanaMailchimp" method="post" target="MailchimpFrame" action="{{ section.settings.mailchimp_action }}">
    <input type="email" name="EMAIL" id="MC_EMAIL">
    <input type="text"  name="FNAME" id="MC_FNAME">
    <input type="text"  name="PHONE" id="MC_PHONE">
    <!-- Mailchimp accepts a comma-separated "tags" field -->
    <input type="hidden" name="tags"  id="MC_TAGS"  value="Contact Form">
    <!-- Honeypot fields Mailchimp expects (keeps it happy even when empty) -->
    <input type="text" name="b_" tabindex="-1" value="">
  </form>
</div>

<script src="{{ 'nb-contact.js' | asset_url }}" defer></script>
</section>

{% schema %}
{
  "name": "Nibana Contact",
  "tag": "section",
  "class": "section",
  "settings": [
    { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme", "default": "background-1" },

    { "type": "text", "id": "heading", "label": "Heading", "default": "Contact" },
    { "type": "textarea", "id": "subheading", "label": "Intro text", "default": "Feel free to ask us anything. We're here to help." },

    { "type": "text", "id": "details_heading", "label": "Contact details heading", "default": "Contact Details" },
    { "type": "text", "id": "details_email", "label": "Email", "default": "info@nibana.life" },
    { "type": "text", "id": "details_phone", "label": "Phone", "default": "+44 20 7173 5775" },
    { "type": "text", "id": "details_note", "label": "Reply-time note", "default": "We usually reply within 1 business day." },

    { "type": "text", "id": "call_heading", "label": "Prefer to talk — heading", "default": "Prefer to talk?" },
    { "type": "text", "id": "call_sub", "label": "Prefer to talk — subtext", "default": "Book a free 20-minute discovery call." },
    { "type": "text", "id": "call_label", "label": "Call CTA label", "default": "Book a Free 20-min Call" },
    { "type": "url",  "id": "call_link", "label": "Call CTA link" },

    { "type": "text", "id": "label_name", "label": "Form label — Name", "default": "Name" },
    { "type": "text", "id": "label_email", "label": "Form label — Email", "default": "Email" },
    { "type": "text", "id": "label_phone", "label": "Form label — Phone", "default": "Phone" },
    { "type": "text", "id": "label_purpose", "label": "Form label — Inquiry Purpose", "default": "Inquiry Purpose" },
    { "type": "text", "id": "purpose_placeholder", "label": "Purpose placeholder", "default": "Choose one…" },
    { "type": "text", "id": "label_message", "label": "Form label — Message", "default": "Message" },

    { "type": "checkbox", "id": "optin_checked", "label": "Opt-in checkbox checked by default", "default": true },
    { "type": "text", "id": "optin_label", "label": "Opt-in label", "default": "Also send me occasional tips & updates" },
    { "type": "textarea", "id": "optin_help", "label": "Opt-in help text", "default": "We'll only email with useful insights. Unsubscribe anytime. No Spam here" },

    { "type": "text", "id": "submit_label", "label": "Submit button label", "default": "Submit" },
    { "type": "text", "id": "success_text", "label": "Success message", "default": "Thanks for reaching out — we’ll get back within 1 business day." },
    { "type": "text", "id": "error_text", "label": "Error message", "default": "Please check the highlighted fields and try again." },

    { "type": "text", "id": "captcha_heading", "label": "Captcha overlay heading", "default": "Almost there…" },
    { "type": "textarea", "id": "captcha_copy", "label": "Captcha overlay copy", "default": "Shopify sometimes asks for a quick captcha. Complete the prompt below to finish sending your message." },
    { "type": "text", "id": "captcha_close_label", "label": "Captcha overlay close label", "default": "Close" },

    { "type": "text", "id": "cta_submit_class", "label": "Submit button class (non-call CTA)", "default": "button" },
    { "type": "text", "id": "cta_call_class", "label": "Book-a-call button class (call CTA)", "default": "nb-cta" },
    { "type": "text", "id": "heading_class", "label": "Heading class", "default": "h1" },
    { "type": "text", "id": "subheading_class", "label": "Subheading class", "default": "paragraph" },
    { "type": "text", "id": "block_heading_class", "label": "Panel heading class", "default": "h3" },

    { "type": "checkbox", "id": "enable_debug", "label": "Enable Mailchimp debug badge (temporary)", "default": false },

    { "type": "checkbox", "id": "use_mailchimp_flow", "label": "Add contacts to Mailchimp directly on submit", "default": true },
    { "type": "url",      "id": "mailchimp_action",  "label": "Mailchimp embed form action (Hosted or Embed URL)" },
    { "type": "checkbox", "id": "use_shopify_customer_flow", "label": "Also create a Shopify customer (may be blocked by hCaptcha)", "default": true },

    { "type": "text", "id": "max_width", "label": "Max width", "default": "1100px" },
    { "type": "text", "id": "section_padding", "label": "Section padding", "default": "48px 16px" },

    { "type": "color", "id": "card_bg", "label": "Panel background (fallback)", "default": "#ffffff" },
    { "type": "color", "id": "card_border", "label": "Panel border (fallback)", "default": "#E5E7EB" },
    { "type": "text",  "id": "card_radius", "label": "Panel border-radius", "default": "16px" },
    { "type": "text",  "id": "card_padding", "label": "Panel padding", "default": "22px" },
    { "type": "text",  "id": "card_shadow", "label": "Panel shadow", "default": "0 8px 24px rgba(0,0,0,.14)" }
  ],
  "blocks": [
    {
      "type": "purpose_option",
      "name": "Purpose option",
      "settings": [
        { "type": "text", "id": "option_label", "label": "Option label", "default": "Discovery Call" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Nibana Contact",
      "blocks": [
        { "type": "purpose_option", "settings": { "option_label": "Discovery Call" } },
        { "type": "purpose_option", "settings": { "option_label": "Men’s Coaching" } },
        { "type": "purpose_option", "settings": { "option_label": "Relationship Coaching" } },
        { "type": "purpose_option", "settings": { "option_label": "Executive Coaching" } },
        { "type": "purpose_option", "settings": { "option_label": "Speaking / Workshops" } },
        { "type": "purpose_option", "settings": { "option_label": "Media / Press" } },
        { "type": "purpose_option", "settings": { "option_label": "Other" } }
      ]
    }
  ]
}
{% endschema %}

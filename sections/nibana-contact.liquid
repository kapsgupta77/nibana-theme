{%- comment -%}
Contact page: visible Shopify CUSTOMER form (creates/updates customer record) with Nibana styling.
Also mirrors to:
- Hidden Shopify CONTACT form (fires store email)
- Hidden Mailchimp form (parallel subscribe)
{%- endcomment -%}

{% liquid
  assign nb_max_width = section.settings.max_width | default: '1100px'
  assign nb_section_padding = section.settings.section_padding | default: '48px 16px'
  assign nb_card_bg = section.settings.card_bg | default: '#ffffff'
  assign nb_card_border = section.settings.card_border | default: '#E5E7EB'
  assign nb_card_radius = section.settings.card_radius | default: '16px'
  assign nb_card_padding = section.settings.card_padding | default: '22px'
  assign nb_card_shadow = section.settings.card_shadow | default: '0 8px 24px rgba(0,0,0,.14)'
  assign nb_card_soft_bg = nb_card_bg | color_lighten: 8
  assign secid = 'nb-contact-' | append: section.id
%}

{%- comment -%} Top safety gap for this section (on the Shopify wrapper) {%- endcomment -%}
<style>
  #shopify-section-{{ section.id }}{
    /* creates real space ABOVE the section, outside of its background */
    margin-top: clamp(28px, 6vw, 96px);
  }
  @media (min-width: 990px){
    #shopify-section-{{ section.id }}{ margin-top: clamp(36px, 7vw, 110px); }
  }
</style>

<section
  id="{{ secid }}"
  class="nb-shell nb-contact"
  style="
    --nb-contact-max-width: {{ nb_max_width }};
    --nb-contact-section-padding: {{ nb_section_padding }};
    --nb-contact-card-bg: {{ nb_card_bg }};
    --nb-contact-card-soft-bg: {{ nb_card_soft_bg }};
    --nb-contact-card-border: {{ nb_card_border }};
    --nb-contact-card-radius: {{ nb_card_radius }};
    --nb-contact-card-padding: {{ nb_card_padding }};
    --nb-contact-card-shadow: {{ nb_card_shadow }};
    padding-block-start: clamp(80px, 10vw, 140px);
  "
  data-nb-contact="true"
>
  <div class="nb-grid cols-2">
    <!-- Left column -->
    <div class="nb-panel">
      <div class="nb-card nb-card--panel nb-contact__left-tray">
        <h1 class="nb-h1">Contact Us</h1>
        <p class="nb-kicker">Feel free to ask us anything. We're here to help.</p>

        <div class="nb-card nb-card--soft">
          <h2 class="nb-h3">Contact Details</h2>
          <p>info@nibana.life<br>+44 20 7173 5775</p>
          <p>We usually reply within 1 business day.</p>
        </div>

        <div class="nb-card nb-card--soft">
          <h2 class="nb-h3">Prefer to talk?</h2>
          <p>Book a free 20-minute discovery call.</p>
          {% liquid
            assign call_url = section.settings.call_link | default: '#'
            assign call_label = section.settings.call_label | strip | default: 'Book a Free 20-min Call'
            assign call_class = section.settings.cta_call_class | strip
          %}
          <p>
            <a
              class="nb-btn nb-btn--primary{% if call_class != blank %} {{ call_class }}{% endif %}"
              href="{{ call_url | escape }}"
            >
              {{ call_label | escape }}
            </a>
          </p>
        </div>
      </div>
    </div>

    <!-- Right column -->
    <div class="nb-panel">
      {%- comment -%} VISIBLE: Shopify CUSTOMER form (creates/updates customer) {%- endcomment -%}
      {% form 'customer', id: 'nb-contact-shopify', class: 'nb-card nb-card--panel nb-contact__form', novalidate: 'novalidate' %}
        <div class="nb-form-grid">
          <div class="nb-field nb-field--full">
            <label class="nb-label" for="nbc-first">First name <span aria-hidden="true">*</span></label>
            <input class="nb-input" id="nbc-first" name="contact[first_name]" type="text" required>
          </div>

          <div class="nb-field nb-field--full">
            <label class="nb-label" for="nbc-last">Last name <span aria-hidden="true">*</span></label>
            <input class="nb-input" id="nbc-last" name="contact[last_name]" type="text" required>
          </div>

          <input type="hidden" id="nbc-name" name="contact[name]">

          <div class="nb-field nb-field--full">
            <label class="nb-label" for="nbc-email">{{ section.settings.label_email | default: 'Email' | escape }} <span aria-hidden="true">*</span></label>
            <input class="nb-input" id="nbc-email" name="contact[email]" type="email" required>
          </div>

          <div class="nb-field nb-field--full">
            <label class="nb-label" for="nbc-phone">{{ section.settings.label_phone | default: 'Phone' | escape }}</label>
            <input class="nb-input" id="nbc-phone" name="contact[phone]" type="tel">
          </div>

          <div class="nb-field nb-field--full">
            <label class="nb-label" for="nbc-reason">{{ section.settings.label_purpose | default: 'Inquiry Purpose' | escape }} <span aria-hidden="true">*</span></label>
            {% liquid
              assign purpose_blocks = section.blocks | where: 'type', 'purpose_option'
            %}
            {% capture purpose_option_markup %}
              {% for block in purpose_blocks %}
                {% assign option_label = block.settings.option_label | strip %}
                {% if option_label != blank %}
                  <option value="{{ option_label | escape }}">{{ option_label | escape }}</option>
                {% endif %}
              {% endfor %}
            {% endcapture %}
            {% assign purpose_option_markup = purpose_option_markup | strip %}
            <select class="nb-input" id="nbc-reason" name="contact[reason]" required>
              <option value="" selected>{{ section.settings.purpose_placeholder | default: 'Choose one…' | escape }}</option>
              {% if purpose_option_markup != blank %}
                {{ purpose_option_markup }}
              {% else %}
                <option value="Coaching enquiry">Coaching enquiry</option>
                <option value="Speaking">Speaking</option>
                <option value="Corporate workshop">Corporate workshop</option>
                <option value="Partnership">Partnership</option>
                <option value="Press">Press</option>
                <option value="Other">Other</option>
              {% endif %}
            </select>
          </div>

          <div class="nb-field nb-field--full">
            <label class="nb-label" for="nbc-message">{{ section.settings.label_message | default: 'Message' | escape }} <span aria-hidden="true">*</span></label>
            <textarea class="nb-input" id="nbc-message" name="contact[body]" rows="6" placeholder="How can we help?" required></textarea>
          </div>
        </div>

        <div class="nb-consent">
          <label class="nb-checkbox">
            <input
              id="nbc-consent"
              type="checkbox"
              {% if section.settings.optin_checked %}checked{% endif %}
            >
            <span>{{ section.settings.optin_label | default: 'Also send me occasional tips & updates' | escape }}</span>
          </label>
          <p class="nb-form-help">{{ section.settings.optin_help | default: "We’ll only email with useful insights. Unsubscribe anytime. No Spam here." | escape }}</p>
        </div>

        <!-- Hidden helper for mirroring tags -->
        <input type="hidden" id="nbc-tags" name="contact[tags]" value="Source: /contact" data-base="Source: /contact">
        <input
          type="hidden"
          id="nbc-accepts"
          name="contact[accepts_marketing]"
          value="{% if section.settings.optin_checked %}true{% else %}false{% endif %}"
        >

        <button type="submit" class="nb-btn nb-btn--teal">{{ section.settings.submit_label | default: 'Submit' | escape }}</button>

        {% if form.errors %}
          <div class="form__message" role="alert">
            <p>{{ section.settings.error_text | default: 'Please check the highlighted fields and try again.' | escape }}</p>
            {{ form.errors | default_errors }}
          </div>
        {% endif %}
        {% if form.posted_successfully? %}
          <div class="nb-card nb-card--soft" role="status">
            <p>{{ section.settings.success_text | default: 'Thanks — your message has been sent. We’ll reply as soon as we can.' | escape }}</p>
          </div>
        {% endif %}
      {% endform %}

      {%- comment -%} HIDDEN: Shopify CONTACT mirror (sends store email) {%- endcomment -%}
      <div aria-hidden="true" style="position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;">
        {% form 'contact', id: 'nb-contact-email', target: 'nbc-email-target', novalidate: 'novalidate' %}
          <input type="text"   id="nbc-email-first"  name="contact[first_name]">
          <input type="text"   id="nbc-email-last"   name="contact[last_name]">
          <input type="text"   id="nbc-email-name"   name="contact[name]">
          <input type="email"  id="nbc-email-email"  name="contact[email]">
          <input type="tel"    id="nbc-email-phone"  name="contact[phone]">
          <input type="text"   id="nbc-email-reason" name="contact[reason]">
          <textarea id="nbc-email-body" name="contact[body]"></textarea>
          <button type="submit">Submit</button>
        {% endform %}
        <iframe id="nbc-email-target" name="nbc-email-target" title="Shopify contact submit"></iframe>
      </div>

      {%- comment -%} HIDDEN: Mailchimp mirror (parallel subscribe) {%- endcomment -%}
      <form action="https://life.us4.list-manage.com/subscribe/post?u=41960bde0a78c656a84bb759b&amp;id=d3d64ba831"
            method="post" target="nbc-mc-target" id="nbc-mc" aria-hidden="true"
            style="position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden;">
        <input type="text"   name="FNAME" id="nbc-mc-fname">
        <input type="text"   name="LNAME" id="nbc-mc-lname">
        <input type="email"  name="EMAIL" id="nbc-mc-email">
        <input type="text"   name="PHONE" id="nbc-mc-phone">
        <input
          type="hidden"
          name="group[78632][1]"
          id="nbc-mc-consent"
          value="{% if section.settings.optin_checked %}1{% else %}0{% endif %}"
        >
        <input type="submit" value="Subscribe">
      </form>
      <iframe name="nbc-mc-target" id="nbc-mc-target" title="Mailchimp submit" hidden></iframe>
    </div>
  </div>
</section>

{% schema %}
{
  "name": "Nibana Contact",
  "tag": "section",
  "class": "section",
  "settings": [
    { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme", "default": "background-1" },

    { "type": "text", "id": "heading", "label": "Heading", "default": "Contact" },
    { "type": "textarea", "id": "subheading", "label": "Intro text", "default": "Feel free to ask us anything. We're here to help." },

    { "type": "text", "id": "details_heading", "label": "Contact details heading", "default": "Contact Details" },
    { "type": "text", "id": "details_email", "label": "Email", "default": "info@nibana.life" },
    { "type": "text", "id": "details_phone", "label": "Phone", "default": "+44 20 7173 5775" },
    { "type": "text", "id": "details_note", "label": "Reply-time note", "default": "We usually reply within 1 business day." },

    { "type": "text", "id": "call_heading", "label": "Prefer to talk — heading", "default": "Prefer to talk?" },
    { "type": "text", "id": "call_sub", "label": "Prefer to talk — subtext", "default": "Book a free 20-minute discovery call." },
    { "type": "text", "id": "call_label", "label": "Call CTA label", "default": "Book a Free 20-min Call" },
    { "type": "url",  "id": "call_link", "label": "Call CTA link" },

    { "type": "text", "id": "label_name", "label": "Form label — Name", "default": "Name" },
    { "type": "text", "id": "label_email", "label": "Form label — Email", "default": "Email" },
    { "type": "text", "id": "label_phone", "label": "Form label — Phone", "default": "Phone" },
    { "type": "text", "id": "label_purpose", "label": "Form label — Inquiry Purpose", "default": "Inquiry Purpose" },
    { "type": "text", "id": "purpose_placeholder", "label": "Purpose placeholder", "default": "Choose one…" },
    { "type": "text", "id": "label_message", "label": "Form label — Message", "default": "Message" },

    { "type": "checkbox", "id": "optin_checked", "label": "Opt-in checkbox checked by default", "default": true },
    { "type": "text", "id": "optin_label", "label": "Opt-in label", "default": "Also send me occasional tips & updates" },
    { "type": "textarea", "id": "optin_help", "label": "Opt-in help text", "default": "We'll only email with useful insights. Unsubscribe anytime. No Spam here" },

    { "type": "text", "id": "submit_label", "label": "Submit button label", "default": "Submit" },
    { "type": "text", "id": "success_text", "label": "Success message", "default": "Thanks for reaching out — we’ll get back within 1 business day." },
    { "type": "text", "id": "error_text", "label": "Error message", "default": "Please check the highlighted fields and try again." },

    { "type": "text", "id": "captcha_heading", "label": "Captcha overlay heading", "default": "Almost there…" },
    { "type": "textarea", "id": "captcha_copy", "label": "Captcha overlay copy", "default": "Shopify sometimes asks for a quick captcha. Complete the prompt below to finish sending your message." },
    { "type": "text", "id": "captcha_close_label", "label": "Captcha overlay close label", "default": "Close" },

    { "type": "text", "id": "cta_submit_class", "label": "Submit button class (non-call CTA)", "default": "button" },
    { "type": "text", "id": "cta_call_class", "label": "Book-a-call button class (call CTA)", "default": "nb-cta" },
    { "type": "text", "id": "heading_class", "label": "Heading class", "default": "h1" },
    { "type": "text", "id": "subheading_class", "label": "Subheading class", "default": "paragraph" },
    { "type": "text", "id": "block_heading_class", "label": "Panel heading class", "default": "h3" },

    { "type": "checkbox", "id": "enable_debug", "label": "Enable Mailchimp debug badge (temporary)", "default": false, "info": "Enable to surface Shopify contact diagnostics (beacon, fetch, iframe logs) for troubleshooting." },

    { "type": "checkbox", "id": "use_mailchimp_flow", "label": "Add contacts to Mailchimp directly on submit", "default": true },
    { "type": "url",      "id": "mailchimp_action",  "label": "Mailchimp embed form action (Hosted or Embed URL)" },
    { "type": "checkbox", "id": "use_shopify_customer_flow", "label": "Also create a Shopify customer (may be blocked by hCaptcha)", "default": true },

    { "type": "text", "id": "max_width", "label": "Max width", "default": "1100px" },
    { "type": "text", "id": "section_padding", "label": "Section padding", "default": "48px 16px" },

    { "type": "color", "id": "card_bg", "label": "Panel background (fallback)", "default": "#ffffff" },
    { "type": "color", "id": "card_border", "label": "Panel border (fallback)", "default": "#E5E7EB" },
    { "type": "text",  "id": "card_radius", "label": "Panel border-radius", "default": "16px" },
    { "type": "text",  "id": "card_padding", "label": "Panel padding", "default": "22px" },
    { "type": "text",  "id": "card_shadow", "label": "Panel shadow", "default": "0 8px 24px rgba(0,0,0,.14)" }
  ],
  "blocks": [
    {
      "type": "purpose_option",
      "name": "Purpose option",
      "settings": [
        { "type": "text", "id": "option_label", "label": "Option label", "default": "Discovery Call" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Nibana Contact",
      "blocks": [
        { "type": "purpose_option", "settings": { "option_label": "Discovery Call" } },
        { "type": "purpose_option", "settings": { "option_label": "Men’s Coaching" } },
        { "type": "purpose_option", "settings": { "option_label": "Relationship Coaching" } },
        { "type": "purpose_option", "settings": { "option_label": "Executive Coaching" } },
        { "type": "purpose_option", "settings": { "option_label": "Speaking / Workshops" } },
        { "type": "purpose_option", "settings": { "option_label": "Media / Press" } },
        { "type": "purpose_option", "settings": { "option_label": "Other" } }
      ]
    }
  ]
}
{% endschema %}

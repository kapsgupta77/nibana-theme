{% comment %}
Testimonials — grid (default) or slider (optional)
Source: Manual blocks (default) or Metaobject `nb_testimonial`
Relies on snippet 'nb-testimonial-card'
{% endcomment %}

{%- liquid
  assign source     = section.settings.source     | default: 'blocks'
  assign limit      = section.settings.limit      | default: 12
  assign heading    = section.settings.heading    | default: 'What our clients say'
  assign sub_raw    = section.settings.subheading | default: '-'
  assign sub        = sub_raw | strip

  assign use_carousel = section.settings.carousel | default: false
  assign per_view     = section.settings.per_view | default: 3

  assign cta_label = section.settings.cta_label   | default: 'View all'
  assign cta_link  = section.settings.cta_link    | default: '/pages/testimonial'
-%}

<section id="nb-testimonials-{{ section.id }}"
         class="nb-testimonials tone-pebble"
         data-carousel="{{ use_carousel }}"
         style="--nb-per-view: {{ per_view | default: 3 }};">
  <div class="nb-shell nb-testimonials__container">

    {%- liquid
      assign show_sub = false
      if sub != '-' and sub != '' 
        assign show_sub = true
      endif
    -%}

    {%- if heading != blank or show_sub -%}
      <header class="nb-testimonials__head">
        {%- if heading != blank -%}
          <h2 class="nb-h2 nb-testimonials__title">{{ heading }}</h2>
        {%- endif -%}
        {%- if show_sub -%}
          <p class="nb-testimonials__dek">{{ sub }}</p>
        {%- endif -%}
      </header>
    {%- endif -%}

    {%- capture cards -%}
      {%- if source == 'metaobject' -%}
        {%- assign mo = shop.metaobjects['nb_testimonial'] -%}
        {%- if mo and mo.values and mo.values.size > 0 -%}
          {%- for m in mo.values limit: limit -%}
            {%- assign q   = m.quote    | default: '' -%}
            {%- assign n   = m.name     | default: '' -%}
            {%- assign tt  = m.title    | default: '' -%}
            {%- assign loc = m.location | default: '' -%}
            {%- assign av  = m.avatar -%}
            {%- assign tg  = m.tags | join: ',' | default: '' -%}
            {% render 'nb-testimonial-card', quote: q, name: n, title: tt, location: loc, avatar: av, tags: tg %}
          {%- endfor -%}
        {%- endif -%}
      {%- else -%}
        {%- for block in section.blocks limit: limit -%}
          {%- assign q   = block.settings.quote    | default: '' -%}
          {%- assign n   = block.settings.name     | default: '' -%}
          {%- assign tt  = block.settings.title    | default: '' -%}
          {%- assign loc = block.settings.location | default: '' -%}
          {%- assign av  = block.settings.avatar -%}
          {%- assign tg  = block.settings.tags     | default: '' -%}
          {% render 'nb-testimonial-card', quote: q, name: n, title: tt, location: loc, avatar: av, tags: tg %}
        {%- endfor -%}
      {%- endif -%}
    {%- endcapture -%}

    {%- if use_carousel -%}
      <div class="nb-tcarousel__viewport" data-viewport>
        <div class="nb-tcarousel__track" data-track>
          {%- comment -%} Wrap each card as a slide {%- endcomment -%}
          {%- assign fragments = cards | split: '<!--SPLIT-->' -%}{% comment %}no-op split to keep capture intact{% endcomment %}
          {{ cards | replace: '<div class="nb-tcard"', '<div class="nb-tcarousel__slide" data-slide><div class="nb-tcard"' | replace: '</div><!-- nb-tcard end -->', '</div></div>' }}
        </div>
      </div>
      <div class="nb-tcarousel__nav" data-nav hidden>
        <button class="nb-tcarousel__btn" type="button" aria-label="Previous" data-dir="-1">‹</button>
        <div class="nb-tcarousel__dots" aria-hidden="true" data-dots></div>
        <button class="nb-tcarousel__btn" type="button" aria-label="Next" data-dir="1">›</button>
      </div>
      {%- if cta_link != blank -%}
        <div class="nb-tcarousel__cta">
          <a class="nb-cta nb-cta--md" href="{{ cta_link }}">{{ cta_label }}</a>
        </div>
      {%- endif -%}
    {%- else -%}
      <div class="nb-tgrid" data-grid>
        {{ cards }}
      </div>
    {%- endif -%}

  </div>
</section>

{% stylesheet %}
  /* Scope everything to this section instance to avoid base.css overrides */
  #nb-testimonials-{{ section.id }} { --t-gap: clamp(14px,2.2vw,22px); }

  #nb-testimonials-{{ section.id }} .nb-testimonials__head{
    text-align:center; margin: 0 0 clamp(8px,1.6vw,16px);
  }
  #nb-testimonials-{{ section.id }} .nb-testimonials__title{
    margin:0 0 6px; color: var(--nb-ink,#223238);
  }
  #nb-testimonials-{{ section.id }} .nb-testimonials__dek{
    margin:0; color:#55656c;
  }

  /* GRID layout (default) */
  #nb-testimonials-{{ section.id }} .nb-tgrid{
    display:grid; gap: var(--t-gap);
    grid-template-columns: repeat(3, minmax(0, 1fr));
    align-items: stretch;
  }
  @media (max-width: 990px){
    #nb-testimonials-{{ section.id }} .nb-tgrid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  }
  @media (max-width: 640px){
    #nb-testimonials-{{ section.id }} .nb-tgrid{ grid-template-columns: 1fr; }
  }

  /* CAROUSEL layout */
  #nb-testimonials-{{ section.id }} .nb-tcarousel__viewport{ position:relative; overflow:hidden; }
  #nb-testimonials-{{ section.id }} .nb-tcarousel__track{
    display:grid; grid-auto-flow:column;
    grid-auto-columns:minmax(320px, 1fr);
    gap:18px; overflow-x:auto; scroll-snap-type:x mandatory;
    padding: 4px 4px 8px; scrollbar-width:none;
  }
  #nb-testimonials-{{ section.id }} .nb-tcarousel__track::-webkit-scrollbar{ display:none; }
  #nb-testimonials-{{ section.id }} .nb-tcarousel__slide{ scroll-snap-align:start; }
  @media (min-width:1024px){
    #nb-testimonials-{{ section.id }} .nb-tcarousel__track{ grid-auto-columns: calc(100% / var(--nb-per-view, 3)); }
  }

  #nb-testimonials-{{ section.id }} .nb-tcarousel__nav{
    display:flex; align-items:center; justify-content:center; gap:14px; margin:12px 0 0;
  }
  #nb-testimonials-{{ section.id }} .nb-tcarousel__btn{
    width:42px; height:42px; border-radius:999px; border:1px solid rgba(0,0,0,.08);
    background:#fff; box-shadow:0 8px 18px rgba(0,0,0,.08);
    font-size:22px; line-height:1; cursor:pointer;
  }
  #nb-testimonials-{{ section.id }} .nb-tcarousel__btn[disabled]{ opacity:.4; cursor:not-allowed; }
  #nb-testimonials-{{ section.id }} .nb-tcarousel__dots{ display:flex; gap:8px; }
  #nb-testimonials-{{ section.id }} .nb-tcarousel__dots i{
    width:7px; height:7px; border-radius:999px; background:#cfd6d2; display:inline-block;
  }
  #nb-testimonials-{{ section.id }} .nb-tcarousel__dots i.is-active{ background:#0C8A7B; }

  #nb-testimonials-{{ section.id }} .nb-tcarousel__cta{ display:flex; justify-content:center; margin:16px 0 0; }

  /* Constrain section top padding when placed in already-padded panels */
  .shopify-section:has(#nb-testimonials-{{ section.id }}) > :not(style):not(script){ padding-top:0 !important; }
{% endstylesheet %}

{% javascript %}
(() => {
  const sec = document.getElementById('nb-testimonials-{{ section.id }}');
  if (!sec) return;

  const isCarousel = (sec.dataset.carousel || 'false') === 'true';
  if (!isCarousel) return;

  const viewport = sec.querySelector('[data-viewport]');
  const track    = sec.querySelector('[data-track]');
  const slides   = Array.from(sec.querySelectorAll('[data-slide]'));
  const nav      = sec.querySelector('[data-nav]');
  const dotsBox  = sec.querySelector('[data-dots]');
  const prevBtn  = sec.querySelector('[data-dir="-1"]');
  const nextBtn  = sec.querySelector('[data-dir="1"]');

  if (!viewport || !track || slides.length === 0 || !nav) return;

  // build "pages" by viewport width
  function pageCount(){
    return Math.max(1, Math.round(track.scrollWidth / viewport.clientWidth));
  }
  function gotoPage(i){
    viewport.scrollTo({ left: i * viewport.clientWidth, behavior:'smooth' });
  }
  function activePage(){
    return Math.round(viewport.scrollLeft / viewport.clientWidth);
  }

  function buildDots(){
    const pages = pageCount();
    dotsBox.innerHTML = '';
    for (let i = 0; i < pages; i++){
      const dot = document.createElement('i');
      if (i === activePage()) dot.classList.add('is-active');
      dot.addEventListener('click', () => gotoPage(i));
      dotsBox.appendChild(dot);
    }
    nav.hidden = pages <= 1;
  }

  function update(){
    const a = activePage();
    dotsBox.querySelectorAll('i').forEach((d, i) => d.classList.toggle('is-active', i === a));
    prevBtn.disabled = a <= 0;
    nextBtn.disabled = a >= pageCount() - 1;
  }

  prevBtn?.addEventListener('click', () => gotoPage(Math.max(0, activePage() - 1)));
  nextBtn?.addEventListener('click', () => gotoPage(activePage() + 1));

  const ro = new ResizeObserver(() => { buildDots(); update(); });
  ro.observe(viewport);

  buildDots();
  update();
  viewport.addEventListener('scroll', () => { requestAnimationFrame(update); }, { passive:true });
})();
{% endjavascript %}

{% schema %}
{
  "name": "Testimonials",
  "class": "section-wrapper nb-testimonials-wrap",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "What our clients say" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "-" },
    { "type": "select", "id": "source", "label": "Source", "options": [
      { "value": "blocks", "label": "Manual (blocks)" },
      { "value": "metaobject", "label": "Metaobject: nb_testimonial" }
    ], "default": "blocks" },
    { "type": "range", "id": "limit", "label": "Max items", "min": 1, "max": 24, "step": 1, "default": 9 },

    { "type": "header", "content": "Slider options" },
    { "type": "checkbox", "id": "carousel", "label": "Show as slider (horizontal scroll)", "default": false },
    { "type": "range", "id": "per_view", "label": "Cards per view (desktop)", "min": 1, "max": 3, "step": 1, "default": 3 },
    { "type": "text", "id": "cta_label", "label": "CTA label", "default": "View all" },
    { "type": "text", "id": "cta_link",  "label": "CTA link",  "default": "/pages/testimonial" }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        { "type": "textarea", "id": "quote", "label": "Quote", "default": "“This work helped me get clear, make braver choices, and feel more alive in daily life.”" },
        { "type": "text",     "id": "name",  "label": "Name", "default": "Client name" },
        { "type": "text",     "id": "title", "label": "Title / descriptor", "default": "Founder" },
        { "type": "text",     "id": "location", "label": "Location", "default": "London, UK" },
        { "type": "image_picker", "id": "avatar", "label": "Avatar (optional)" },
        { "type": "text",     "id": "tags",  "label": "Tags (optional)", "default": "-" }
      ]
    }
  ],
  "presets": [{ "name": "Testimonials" }]
}
{% endschema %}

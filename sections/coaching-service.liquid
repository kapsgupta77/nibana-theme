{%- comment -%}
  Coaching Service (metaobject-driven)
  Page metafield: either custom.coaching_service OR coachingservice.coaching_service
{%- endcomment -%}

{%- liquid
  assign cs_custom    = page.metafields.custom.coaching_service
  assign cs_canonical = page.metafields.coachingservice.coaching_service
  assign service_ref  = cs_custom | default: cs_canonical
-%}

{%- if service_ref and service_ref.value -%}
{%- assign service = service_ref.value -%}

<style>
  /* ===========================
     Local tokens (kept aligned with brand)
     =========================== */
  :root{
    --nb-ink:#223238;
    --nb-muted:#324247;
    --nb-deep:#0F5B59;
    --nb-sage:#EAF4F3;
    --nb-sage-strong:#e6eeea;
    --nb-chocolate:#C86B2A;
  }

  .nb-shell{max-width:min(1160px,94vw);margin-inline:auto}
  .nb-grid{display:grid;gap:22px}

  /* Headings use theme heading family; body uses theme body family */
  .nb-h1,.nb-h2,.nb-h3{ font-family: var(--font-heading-family,inherit); color: var(--nb-ink); }
  .nb-h1{ font-size:clamp(30px,4.4vw,48px); line-height:1.1; margin:0 0 10px; font-weight:800; }
  .nb-h2{ font-size:clamp(22px,2.8vw,28px); font-weight:800; margin:0 0 6px; }
  .nb-h3{ font-size:clamp(18px,2.1vw,22px); font-weight:750; margin:0 0 10px; }
  /* tone tweak for brand */
  .nb-h2,.nb-h3{ color: var(--nb-deep); }  /* H1 stays on --nb-ink; H2/H3 on deep */

  /* Body copy */
  .nb-copy,.nb-tray,.nb-hero p,.nb-card,.nb-faq__a{font-family:var(--font-body-family,inherit);color:var(--nb-muted)}

  /* Hero */
  .nb-hero{display:grid;grid-template-columns:1.1fr .9fr;align-items:center;gap:28px}
  @media (max-width:990px){ .nb-hero{grid-template-columns:1fr} }
  .nb-hero p{margin:0 0 16px}
  .nb-hero_img{width:100%;height:auto;border-radius:18px;box-shadow:0 14px 34px rgba(0,0,0,.08)}
  .nb-hero_placeholder{aspect-ratio:16/9;border-radius:18px;background:linear-gradient(135deg,#e8f1ee,#f3f6ef)}

  /* CTA */
  .nb-cta{display:inline-flex;align-items:center;justify-content:center;padding:.9rem 1.1rem;border-radius:999px;background:var(--nb-chocolate);color:#fff;text-decoration:none;box-shadow:0 10px 24px rgba(0,0,0,.08)}
  .nb-cta:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.10)}

  /* Trays / cards */
  .nb-tray{background:var(--nb-sage);border-radius:18px;padding:18px 20px;box-shadow:0 10px 26px rgba(0,0,0,.06)}
  .nb-card{background:#fff;border-radius:12px;box-shadow:0 8px 22px rgba(0,0,0,.06);padding:12px 14px}
  .nb-badges{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (max-width:720px){ .nb-badges{grid-template-columns:1fr} }

  /* Duo cards (myths / truths) */
  .nb-duo{display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:start}
  @media (max-width:900px){.nb-duo{grid-template-columns:1fr}}
  .nb-duo .nb-card{padding:18px 20px}

  /* Lists */
  .nb-list{margin:0;padding-left:1.15rem}
  .nb-list li{margin:.28rem 0}

  /* General RTE */
  .nb-rte{line-height:1.65}
  .nb-rte h3{margin:.25rem 0 .35rem}

  /* Method pills (your existing behavior h3+ul + any ul inside method body) */
  .nb-method__body h3 + ul,
  .nb-method__body ul{
    list-style:none;margin:10px 0 0;padding:0;display:flex;flex-wrap:wrap;gap:10px
  }
  .nb-method__body h3 + ul li,
  .nb-method__body ul li{
    background:#fff;border:1px solid rgba(0,0,0,.06);
    border-radius:999px;padding:.4rem .65rem;line-height:1.2;box-shadow:0 4px 12px rgba(0,0,0,.05)
  }

  /* Rich text callouts */
  .nb-method .nb-rte p + ul,
  .nb-method .nb-rte p + ol,
  .nb-method .nb-rte ul,
  .nb-method .nb-rte ol{
    border:1px solid rgba(0,0,0,.06);
    border-radius:12px;
    box-shadow:0 8px 22px rgba(0,0,0,.06);
    padding:14px 16px;
    line-height:1.65;
    margin:10px 0 16px;
    color:var(--nb-muted);
  }

  /* FAQ (global pill look) */
  .nb-faq--wrap{ margin:22px 0; }
  .nb-faq__title{ color:var(--nb-ink); text-align:center; font-weight:800; margin:0 0 16px; font-family:var(--font-heading-family,inherit); }
  .nb-faq__list{ display:grid; gap:18px; }
  .nb-faq__item{ background:transparent; border:0; box-shadow:none; overflow:visible; }
  .nb-faq__q{
    position:relative; background:var(--nb-deep); color:#fff; border:0; border-radius:9999px;
    padding:16px 64px 16px 22px; font-weight:720; box-shadow:0 4px 14px rgba(0,0,0,.05);
    display:grid; grid-template-columns:1fr auto; align-items:center; list-style:none; cursor:pointer;
    font-family:var(--font-body-family,inherit);
  }
  .nb-faq__q::-webkit-details-marker{ display:none; }
  .nb-faq__q:hover{ background:#0e5452; }
  .nb-faq__q::after{
    content:"+"; position:absolute; right:10px; top:50%; transform:translateY(-50%);
    width:38px; height:38px; border-radius:9999px; display:grid; place-items:center;
    color:#fff; background:rgba(255,255,255,.14); font-size:22px; font-weight:800; line-height:1;
  }
  details[open] .nb-faq__q::after{ content:"–"; }
  .nb-faq__a{
    background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:14px;
    margin:10px 14px 2px; padding:16px 20px; color:var(--nb-muted); line-height:1.65;
  }

  /* ===========================
     New: Process timeline + Sticky CTA
     =========================== */
  /* Process timeline */
  .nb-steps{counter-reset:step;display:grid;gap:12px;list-style:none;padding-left:0;margin:0;}
  .nb-steps li{position:relative;background:#fff;border:1px solid #e8ecef;border-radius:14px;padding:12px 14px 12px 48px;box-shadow:0 1px 3px rgba(0,0,0,.05);}
  .nb-steps li::before{counter-increment:step;content:counter(step);position:absolute;left:12px;top:12px;width:28px;height:28px;display:grid;place-items:center;border-radius:999px;background:var(--nb-sage);color:var(--nb-deep);font-weight:700;border:1px solid rgba(0,0,0,.06);}
  .nb-steps li + li{margin-top:8px;}
  .nb-steps li + li::after{content:"";position:absolute;left:25px;top:-8px;bottom:calc(100% - 8px);width:2px;background:rgba(0,0,0,.06);}

  /* Sticky mobile CTA */
  .nb-sticky-cta{
    position:fixed;left:0;right:0;bottom:0;z-index:40;display:none;
    padding:max(10px, env(safe-area-inset-bottom));background:linear-gradient(to top, rgba(255,255,255,.98), rgba(255,255,255,.88));
    border-top:1px solid #e8ecef;backdrop-filter:saturate(180%) blur(6px);
  }
  .nb-sticky-cta__btn{
    display:block;text-align:center;font-weight:700;text-decoration:none;
    background:var(--nb-chocolate);color:#fff;padding:.9rem 1.1rem;border-radius:999px;box-shadow:0 1px 3px rgba(0,0,0,.12);
  }
  @media (max-width:860px){ .nb-sticky-cta{display:block;} .nb-shell{padding-bottom:84px;} }
</style>

<section class="nb-shell nb-grid" data-coaching-service="{{ service.id | default: service.title | escape }}">

  {%- comment -%} ---------- Shared CTA ---------- {%- endcomment -%}
  {%- liquid
    assign btn_label = service.cta_label | default: 'Book a free 20-min call'
    assign btn_href  = service.cta_link
    if btn_href == blank
      assign btn_href = '/pages/book-a-call'
    endif
  -%}

  {%- comment -%} ---------- HERO ---------- {%- endcomment -%}
  <div class="nb-hero">
    <div class="nb-copy">
      <h1 
        class="nb-h1">{{ service.hero_heading | default: service.title | default: 'Transformational life coaching helps you change from the inside out.' }}</h1>
      {%- if service.hero_subheading != blank -%}
        <p>{{ service.hero_subheading }}</p>
      {%- endif -%}
      <a class="nb-cta" href="{{ btn_href }}" data-cta="service-hero-cta">{{ btn_label }}</a>
    </div>

    <div>
      {%- if service.hero_video_url -%}
        <div class="nb-hero_placeholder">
          <iframe width="100%" height="100%" style="width:100%;aspect-ratio:16/9;border:0;border-radius:18px"
            src="https://www.youtube.com/embed/{{ service.hero_video_url | split: 'v=' | last | split: '&' | first }}"
            title="Intro video" allow="accelerometer; autoplay; ...rite; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
        </div>
      {%- elsif service.hero_image -%}
        <img
          src="{{ service.hero_image | image_url: width: 1400 }}"
          srcset="
            {{ service.hero_image | image_url: width: 700 }} 700w,
            {{ service.hero_image | image_url: width:1000 }} 1000w,
            {{ service.hero_image | image_url: width:1400 }} 1400w
          "
          sizes="(max-width: 990px) 100vw, 640px"
          alt="{{ service.hero_heading | default: service.title | escape }}"
          class="nb-hero_img" loading="eager" fetchpriority="high">
      {%- else -%}
        <div class="nb-hero_placeholder"></div>
      {%- endif -%}
    </div>
  </div>

  {%- comment -%} ---------- line break normalization token ---------- {%- endcomment -%}
  {%- comment -%} Using a fixed token as BR surrogate to normalize newline_to_br → <br> variants; falls back to commas
  {%- endcomment -%}
  {%- assign br_tag = '<br />' -%}

  {%- comment -%} ---------- SOCIAL PROOF (optional) ---------- {%- endcomment -%}
  {%- liquid
    assign sp_raw  = service.social_proof | append: ''
    assign sp_html = sp_raw | newline_to_br
    assign sp_norm = sp_html | replace: '<br/>', br_tag | replace: '<br>', br_tag
    assign sp_pipe = sp_norm | replace: br_tag, '|||'
    assign sp      = sp_pipe | split: '|||'
    assign sp_filled = 0
    for x in sp
      assign t = x | strip
      if t != '' 
        assign sp_filled = sp_filled | plus: 1
      endif
    endfor
  -%}
  {%- if sp_filled > 0 -%}
    <div class="nb-tray">
      <div class="nb-badges">
        {%- for s in sp -%}{%- assign sv = s | strip -%}{% if sv != '' %}<div class="nb-card">{{ sv }}</div>{% endif %}{%- endfor -%}
      </div>
    </div>
  {%- endif -%}

  {%- comment -%} ---------- OUTCOMES ---------- {%- endcomment -%}
  {%- liquid
    assign oc_raw  = service.outcomes | append: ''
    assign oc_html = oc_raw | newline_to_br
    assign oc_norm = oc_html | replace: '<br/>', br_tag | replace: '<br>', br_tag | replace: '&nbsp;', ' '
    assign oc_pipe = oc_norm | replace: br_tag, '|||'
    assign outcomes = oc_pipe | split: '|||'
    assign oc_count = 0
    for it in outcomes
      assign t = it | strip
      if t != '' 
        assign oc_count = oc_count | plus: 1
      endif
    endfor
  -%}
  {%- if oc_count > 0 -%}
    <div class="nb-tray">
      <h2 class="nb-h2">What you’ll get</h2>
      <div class="nb-badges">
        {%- for item in outcomes -%}
          {%- assign it = item | strip -%}{% if it != '' %}<div class="nb-card">{{ it }}</div>{% endif %}
        {%- endfor -%}
      </div>
    </div>
  {%- endif -%}

  {%- comment -%} ---------- IS THIS FOR YOU ---------- {%- endcomment -%}
  {%- liquid
    assign ify_raw  = service.is_for_you | append: ''
    assign ify_html = ify_raw | newline_to_br
    assign ify_norm = ify_html | replace: '<br/>', br_tag | replace: '<br>', br_tag
    assign ify_pipe = ify_norm | replace: br_tag, '|||'
    assign ify = ify_pipe | split: '|||'
    assign ify_count = 0
    for it in ify
      assign t = it | strip
      if t != '' 
        assign ify_count = ify_count | plus: 1
      endif
    endfor
  -%}
  {%- if ify_count > 0 -%}
    <div class="nb-tray">
      <h3 class="nb-h3">Is this for you?</h3>
      <ul class="nb-list">
        {%- for line in ify -%}
          {%- assign l = line | strip -%}{% if l != '' %}<li>{{ l }}</li>{% endif %}
        {%- endfor -%}
      </ul>
    </div>
  {%- endif -%}

  {%- comment -%} ---------- PROCESS ---------- {%- endcomment -%}
  {%- liquid
    assign steps_raw  = service.process_bodies | append: ''
    assign steps_html = steps_raw | newline_to_br
    assign steps_norm = steps_html | replace: '<br/>', br_tag | replace: '<br>', br_tag
    assign steps_pipe = steps_norm | replace: br_tag, '|||'
    assign steps = steps_pipe | split: '|||'
    assign steps_count = 0
    for s in steps
      assign t = s | strip
      if t != ''
        assign steps_count = steps_count | plus: 1
      endif
    endfor
  -%}
  {%- if service.process_titles or steps_count > 0 -%}
    <div class="nb-tray">
      <h3 class="nb-h3">{{ service.process_titles | default: 'The Process' }}</h3>
      {%- if steps_count > 0 -%}
        <!-- New: add nb-steps for timeline look -->
        <ol class="nb-list nb-steps">
          {%- for step in steps -%}
            {%- assign s = step | strip -%}{% if s != '' %}<li>{{ s }}</li>{% endif %}
          {%- endfor -%}
        </ol>
      {%- endif -%}
    </div>
  {%- endif -%}

  {%- comment -%} ---------- METHOD (RICH TEXT) ---------- {%- endcomment -%}
  {%- if service.method_title or service.method_richtext -%}
    <div class="nb-tray nb-method">
      <h2 class="nb-h2">{{ service.method_title | default: 'Nibana Self-Mastery Framework' }}</h2>
      {%- if service.method_richtext -%}
        <div class="nb-rte nb-method__body">
          {{ service.method_richtext | metafield_tag }}
        </div>
      {%- endif -%}
    </div>
  {%- endif -%}

  {%- comment -%} ---------- MYTHS / TRUTHS (two-column cards; robust splitting) ---------- {%- endcomment -%}
  {%- liquid
    assign myths_raw  = service.myths  | append: ''
    assign truths_raw = service.truths | append: ''

    assign myths_html  = myths_raw  | newline_to_br
    assign truths_html = truths_raw | newline_to_br

    assign myths_norm  = myths_html  | replace: '<br/>','<br />' | replace: '<br>','<br />' | replace: '<br />\r\n','<br />' | replace: '<br />\r','<br />' | replace: '<br />\n','<br />' | replace: '&nbsp;',' '
    assign truths_norm = truths_html | replace: '<br/>','<br />' | replace: '<br>','<br />' | replace: '<br />\r\n','<br />' | replace: '<br />\r','<br />' | replace: '<br />\n','<br />' | replace: '&nbsp;',' '

    assign myths_pipe  = myths_norm  | replace: '<br />','|||'
    assign truths_pipe = truths_norm | replace: '<br />','|||'

    assign myths  = myths_pipe  | split: '|||'
    assign truths = truths_pipe | split: '|||'

    assign myths_count = 0
    for m in myths
      assign t = m | strip
      if t != '' 
        assign myths_count = myths_count | plus: 1
      endif
    endfor

    assign truths_count = 0
    for t in truths
      assign z = t | strip
      if z != '' 
        assign truths_count = truths_count | plus: 1
      endif
    endfor
  -%}
  {%- if myths_count > 0 or truths_count > 0 -%}
    <div class="nb-duo">
      {%- if myths_count > 0 -%}
        <div class="nb-card nb-duo__col">
          <h3 class="nb-h3">Common myths</h3>
          <ul class="nb-list">
            {%- for m in myths -%}
              {%- assign mm = m | strip -%}
              {%- if mm != '' -%}<li>{{ mm }}</li>{%- endif -%}
            {%- endfor -%}
          </ul>
        </div>
      {%- endif -%}

      {%- if truths_count > 0 -%}
        <div class="nb-card nb-duo__col">
          <h3 class="nb-h3">What’s actually true</h3>
          <ul class="nb-list">
            {%- for t in truths -%}
              {%- assign tt = t | strip -%}
              {%- if tt != '' -%}<li>{{ tt }}</li>{%- endif -%}
            {%- endfor -%}
          </ul>
        </div>
      {%- endif -%}
    </div>

    <style>
      /* two-column layout for myths/truths */
      .nb-duo{display:grid;grid-template-columns:1fr 1fr;gap:18px}
      @media (max-width: 780px){ .nb-duo{grid-template-columns:1fr} }
      .nb-duo__col{padding:16px 18px}
    </style>
  {%- endif -%}

  {%- comment -%} ---------- FAQ (global pill look + robust splitting; keeps single-open) ---------- {%- endcomment -%}
  {%- liquid
    assign q_raw = service.faqs_q | append: ''
    assign a_raw = service.faqs_a | append: ''

    assign q_html = q_raw | newline_to_br
    assign q_norm = q_html | replace: '<br/>', br_tag | replace: '<br>', br_tag
    assign q_pipe = q_norm | replace: br_tag, '|||'
    assign qs     = q_pipe | split: '|||'

    assign a_html = a_raw | newline_to_br
    assign a_norm = a_html | replace: '<br/>', br_tag | replace: '<br>', br_tag | replace: '&nbsp;', ' '
    assign a_norm = a_norm | replace: '<br /><br /><br />', '§§'
    assign a_norm = a_norm | replace: '<br /><br />',       '§§'
    assign a_norm = a_norm | replace: '<br /> <br />',      '§§'
    assign a_norm = a_norm | replace: '<br />  <br />',     '§§'
    assign a_norm = a_norm | replace: '<br />   <br />',    '§§'
    assign a_norm = a_norm | replace: '---',                '§§'
    assign as     = a_norm | split: '§§'

    assign q_count = 0
    for q in qs
      assign qq = q | strip_html | strip
      if qq != '' 
        assign q_count = q_count | plus: 1
      endif
    endfor
  -%}

  {%- if q_count > 0 -%}
    <div class="nb-tray nb-faq--wrap">
      <h2 class="nb-faq__title">Frequently asked questions</h2>

      <div class="nb-faq__list" id="nb-faq-{{ section.id }}-svc">
        {%- assign idx = 0 -%}
        {%- for q in qs -%}
          {%- assign qq = q | strip_html | strip -%}
          {%- if qq != '' -%}
            {%- assign a_block = as[idx] | default: '' -%}
            {%- assign a_clean = a_block | strip -%}
            {%- assign head6 = a_clean | slice: 0,6 -%}
            {%- assign head5 = a_clean | slice: 0,5 -%}
            {%- assign head4 = a_clean | slice: 0,4 -%}
            {%- if head6 == '<br />' -%}{% assign a_clean = a_clean | replace_first: '<br />','' %}{% endif -%}
            {%- if head5 == '<br/>'  -%}{% assign a_clean = a_clean | replace_first: '<br/>',''  %}{% endif -%}
            {%- if head4 == '<br>'   -%}{% assign a_clean = a_clean | replace_first: '<br>',''   %}{% endif -%}

            <details class="nb-faq__item"{% if forloop.first %} open{% endif %}>
              <summary class="nb-faq__q">{{ qq }}</summary>
              <div class="nb-faq__a rte">{{ a_clean }}</div>
            </details>

            {%- assign idx = idx | plus: 1 -%}
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>

    {%- comment -%} FAQ JSON-LD {%- endcomment -%}
    {%- assign a_count = as.size -%}
    {%- assign pair_count = q_count -%}
    {%- if a_count < q_count -%}{%- assign pair_count = a_count -%}{%- endif -%}
    {%- if pair_count > 0 -%}
    <script type="application/ld+json">
    {
      "@context":"https://schema.org",
      "@type":"FAQPage",
      "mainEntity":[
        {%- assign last = pair_count | minus: 1 -%}
        {%- assign first = true -%}
        {%- for i in (0..last) -%}
          {%- assign q = qs[i] | strip_html | strip -%}
          {%- assign a = as[i] | strip -%}
          {%- if q != '' and a != '' -%}
            {%- unless first -%},{%- endunless -%}
            { "@type":"Question", "name": {{ q | json }}, "acceptedAnswer": { "@type":"Answer", "text": {{ a | json }} } }
            {%- assign first = false -%}
          {%- endif -%}
        {%- endfor -%}
      ]
    }
    </script>
    {%- endif -%}

    <script>
      (function(){
        var root = document.getElementById('nb-faq-{{ section.id }}-svc');
        if(!root) return;
        root.addEventListener('toggle', function(ev){
          var d = ev.target;
          if(d.tagName !== 'DETAILS' || !d.open) return;
          root.querySelectorAll('details[open]').forEach(function(o){ if(o!==d) o.open=false; });
        }, true);
      })();
    </script>
  {%- endif -%}

  {%- comment -%} ---------- BOTTOM CTA ---------- {%- endcomment -%}
  <div style="text-align:center;padding:10px 0 24px">
    <a class="nb-cta" href="{{ btn_href }}" data-cta="service-bottom-cta">{{ btn_label }}</a>

    <!-- Sticky Mobile CTA -->
    <div class="nb-sticky-cta" data-cta="service-sticky-cta">
      <a class="nb-sticky-cta__btn" href="{{ btn_href }}">{{ btn_label }}</a>
    </div>
  </div>

</section>

{%- else -%}
<section class="page--width" style="padding:40px 0;">
  <p>No coaching service selected for this page.</p>
</section>
{%- endif -%}

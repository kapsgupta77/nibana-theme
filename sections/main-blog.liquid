<script
  src="{{ 'blog-posts-list.js' | asset_url }}"
  type="module"
  fetchpriority="low"
></script>

<blog-posts-list section-id="{{ section.id }}">
{%- liquid
  assign b_hero_title = blog.metafields.custom.hero_title | default: ''
  assign b_hero_dek   = blog.metafields.custom.hero_dek   | default: ''
  assign b_hero_tone  = blog.metafields.custom.hero_tone  | default: 'pebble'
  assign b_hero_img   = blog.metafields.custom.hero_image
  assign b_cta_label  = blog.metafields.custom.cta_label  | default: ''
  assign b_cta_link   = blog.metafields.custom.cta_link   | default: ''
  assign b_show_tags  = blog.metafields.custom.show_tags  | default: false
-%}

{%- comment -%} ---------------- HERO ---------------- {%- endcomment -%}
{%- assign hero_classes = 'nb-blog-hero tone-' | append: b_hero_tone -%}
{%- if b_hero_img == blank -%}
  {%- assign hero_classes = hero_classes | append: ' has-no-media' -%}
{%- endif -%}

{% if b_hero_title != '' or b_hero_img %}
  <section class="{{ hero_classes }}">
    <div class="nb-blog-hero__inner">
      {% if b_hero_img %}
        <figure class="nb-blog-hero__media">
          {{ b_hero_img
            | image_url: width: 1400
            | image_tag: alt: b_hero_title, class: 'nb-blog-hero__img', sizes: "100vw", widths: "600,900,1200,1400" }}
        </figure>
      {% endif %}
      <div class="nb-blog-hero__copy">
        {% if b_hero_title != '' %}
          <h1 class="nb-h2 nb-blog-hero__title">{{ b_hero_title }}</h1>
        {% endif %}
        {% if b_hero_dek != '' %}
          <p class="nb-blog-hero__dek">{{ b_hero_dek }}</p>
        {% endif %}
        {% if b_cta_label != '' and b_cta_link != '' %}
          <a class="nb-cta nb-cta--md" href="{{ b_cta_link }}">{{ b_cta_label }}</a>
        {% endif %}
      </div>
    </div>
  </section>
{% endif %}

{% if b_show_tags %}
  {%- comment -%} Blog Filters: Categories + Subtopics (metafields-driven; tag-fallback) {%- endcomment -%}
  {%- assign nb_categories = "Men’s Work|Relationships|Emotional Intelligence|Leadership|Embodiment|Sexuality|Self-Discovery" | split: "|" -%}
  <div class="nb-blog-filter" data-nb-blog-filter>
    <div class="nb-filter-row nb-filter-row--cats" role="tablist" aria-label="Categories">
      <button class="nb-chip nb-chip--on" data-cat="All" role="tab" aria-selected="true">All</button>
      {%- for c in nb_categories -%}
        <button class="nb-chip" data-cat="{{ c | escape }}" role="tab" aria-selected="false">{{ c }}</button>
      {%- endfor -%}
    </div>
    <div class="nb-filter-row nb-filter-row--search">
      <input class="nb-subtopic-input" type="search" placeholder="Search subtopics…" aria-label="Search subtopics" />
      <button class="nb-clear" type="button" hidden>Clear</button>
    </div>
    <div class="nb-filter-row nb-filter-row--popular" hidden></div>
  </div>
{% endif %}

{%- comment -%} ---------------- POSTS GRID ---------------- {%- endcomment -%}
  <div class="section-background color-{{ section.settings.color_scheme }}"></div>
  <div
    class="
      section
      color-{{ section.settings.color_scheme }}
      blog-posts
      spacing-style
      size-style
    "
    style="{% render 'spacing-style', settings: section.settings %}"
  >
    {% content_for 'blocks' %}

    {%- paginate blog.articles by 12 -%}
      <span ref="viewMorePrevious"></span>
      <div ref="grid" class="blog-posts-container" data-last-page="{{ paginate.pages }}">

        {%- comment -%} Pass 1: pinned posts {%- endcomment -%}
        {% for article in blog.articles %}
          {% if article.metafields.custom.pinned == true %}
            <div class="blog-post-item" ref="cards[]" data-page="{{ paginate.current_page }}">
              {% content_for 'block', id: 'static-blog-post-card', type: '_blog-post-card', article: article %}
            </div>
          {% endif %}
        {% endfor %}

        {%- comment -%} Pass 2: the rest {%- endcomment -%}
        {% for article in blog.articles %}
          {% unless article.metafields.custom.pinned == true %}
            <div class="blog-post-item" ref="cards[]" data-page="{{ paginate.current_page }}">
              {% content_for 'block', id: 'static-blog-post-card', type: '_blog-post-card', article: article %}
            </div>
          {% endunless %}
        {% endfor %}

      </div>
      <span ref="viewMoreNext"></span>
    {%- endpaginate -%}
  </div>
</blog-posts-list>

{% stylesheet %}
/* ===== Blog hero ===== */
.nb-blog-hero{ background:var(--nb-sage,#EAF4F3); padding:clamp(14px,3vw,28px) 0; }
.nb-blog-hero__inner{
  max-width:min(1160px,94vw); margin-inline:auto;
  display:grid; grid-template-columns:1.25fr .75fr; gap:24px; align-items:center;
}
.nb-blog-hero__media{ border-radius:18px; overflow:hidden; box-shadow:0 14px 32px rgba(0,0,0,.08); }
.nb-blog-hero__img{ display:block; width:100%; height:auto; }
.nb-blog-hero.has-no-media .nb-blog-hero__inner{ grid-template-columns:1fr; text-align:center; }
.nb-blog-hero.has-no-media .nb-blog-hero__copy{ display:grid; place-items:center; }
.nb-blog-hero__title{ margin:0 0 .4rem; }
.nb-blog-hero__dek{ max-width:60ch; }

/* ===== Existing posts grid (unchanged) ===== */
.blog-posts {
  --page-content-width: var(--narrow-page-width);
  --page-width: calc(var(--page-content-width) + (var(--page-margin) * 2));
  --columns-gap: 36px;
  --rows-gap: 36px;
}
.blog-posts-container {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 1rem;
  width: 100%;
  column-gap: var(--columns-gap);
  row-gap: var(--rows-gap);
}
.blog-post-item {
  --blog-post-card-scale: 0.6;
  grid-column: span 2;
}
@media screen and (max-width: 749px) {
  .blog-post-item { --blog-post-card-scale: 0.5; grid-column: span 6; }
}
.blog-post-item:nth-child(2),
.blog-post-item:nth-child(3) {
  --blog-post-card-scale: 0.8; grid-column: span 3;
}
@media screen and (max-width: 749px) {
  .blog-post-item:nth-child(2),
  .blog-post-item:nth-child(3) { --blog-post-card-scale: 0.5; grid-column: span 6; }
}
.blog-post-item:first-child { --blog-post-card-scale: 1; grid-column: span 6; }
.blog-post-item { border: 1px solid rgb(var(--color-foreground-rgb) / var(--opacity-20)); padding: 0 1rem 1rem; }
.blog-post-item:has(.blog-post-card__image-container) { border: none; padding: 0; }
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.blog_posts",
  "blocks": [
    { "type": "@theme" },
    { "type": "@app" },
    { "type": "text" },
    { "type": "icon" },
    { "type": "image" },
    { "type": "button" },
    { "type": "video" },
    { "type": "group" },
    { "type": "spacer" },
    { "type": "_divider" }
  ],
  "disabled_on": { "groups": ["header"] },
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    },
    { "type": "header", "content": "t:content.padding" },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0, "max": 100, "step": 1, "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0, "max": 100, "step": 1, "unit": "px",
      "default": 0
    }
  ]
}
{% endschema %}

{%- liquid
  assign card_article = article
  assign card_alignment = alignment | default: 'left'
-%}
{%- if card_article == blank -%}
  {%- comment -%}No article to render{%- endcomment -%}
{%- else -%}
  {%- liquid
    assign cat = card_article.metafields.custom.primary_category | default: ''
    assign topics_metafield = card_article.metafields.custom.subtopics
    assign topics = ''
    if topics_metafield != blank
      if topics_metafield.value
        assign topics = topics_metafield.value
      else
        assign topics = topics_metafield
      endif
    endif

    assign cat_fallback = ''
    if cat == '' and card_article.tags
      assign known = "Men’s Work|Relationships|Emotional Intelligence|Leadership|Embodiment|Sexuality|Self-Discovery" | split: "|"
      for t in card_article.tags
        assign t_down = t | downcase
        for k in known
          assign k_down = k | downcase
          if t_down == k_down
            assign cat_fallback = t
            break
          endif
        endfor
        if cat_fallback != ''
          break
        endif
      endfor
    endif

    assign cat_final = cat | default: cat_fallback

    assign topics_joined = ''
    if topics != ''
      assign topics_joined = topics | join: ','
    else
      assign topic_tags = ''
      for t in card_article.tags
        if t != cat_final and t != ''
          if topic_tags == ''
            assign topic_tags = t
          else
            assign topic_tags = topic_tags | append: ',' | append: t
          endif

        endif
      endfor
      assign topics_joined = topic_tags
    endif

    assign image_alt = ''
    if card_article.image
      assign image_alt = card_article.image.alt | default: card_article.title
      assign image_alt = image_alt | strip | escape
    endif

    assign nb_related_post_card_css = nb_related_post_card_css | default: ''
  -%}
  {%- if nb_related_post_card_css == '' -%}
    {%- assign nb_related_post_card_css = 'set' -%}
    {{ 'nb-related-cards.css' | asset_url | stylesheet_tag }}
  {%- endif -%}
  <a
    class="nb-related-card"
    href="{{ card_article.url }}"
    data-cat="{{ cat_final | escape }}"
    data-topics="{{ topics_joined | escape }}"
    style="--nb-related-card-align: {{ card_alignment }}"
  >
    <div class="nb-related-card__media">
      {%- if card_article.image -%}
        {{ card_article.image | image_url: width: 960 | image_tag: loading: 'lazy', sizes: '(min-width: 990px) 320px, 60vw', alt: image_alt, class: 'nb-related-card__image', widths: '320, 480, 640, 800, 960', placeholder: 'blurred' }}
      {%- else -%}
        <div class="nb-related-card__image nb-related-card__image--placeholder" role="presentation" aria-hidden="true"></div>
      {%- endif -%}
    </div>
    <div class="nb-related-card__body">
      <h3 class="nb-related-card__title h4">{{ card_article.title | escape }}</h3>
      <div class="nb-related-card__meta">
        {%- if card_article.published_at -%}
          <span class="nb-related-card__date">{{ card_article.published_at | time_tag: format: 'date' }}</span>
        {%- endif -%}
        {%- if card_article.published_at -%}
          <span class="nb-related-card__sep" aria-hidden="true">·</span>
        {%- endif -%}
        <span class="nb-related-card__read">{% render 'reading-time', article: card_article %}</span>
      </div>
      {%- assign excerpt_source = card_article.excerpt | strip_html -%}
      {%- if excerpt_source == '' -%}
        {%- assign excerpt_source = card_article.content | strip_html -%}
      {%- endif -%}
      {%- if excerpt_source != '' -%}
        <p class="nb-related-card__excerpt">{{ excerpt_source | truncatewords: 28 | escape }}</p>
      {%- endif -%}
    </div>
  </a>
{%- endif -%}

{%- comment -%}
Service-page testimonials belt (diagnostic, robust).
Source priority:
1) service.testimonials_list         (direct)
2) service.testimonials_list.value
3) service.testimonials_list.values
4) shop.metaobjects[...] (global fallback)
Filter: `tag_filter` param OR service.testimonials_tag_filter; "All" disables filtering.
Limit: `limit` param (default 4)
{%- endcomment -%}

{%- liquid
  assign _heading = heading | default: 'What clients say'
  assign _limit   = limit   | default: 4
  assign _svc     = service

  assign _raw = tag_filter
  if _raw == blank and _svc
    assign _raw = _svc.testimonials_tag_filter
  endif
  if _raw == blank
    assign _raw = 'All'
  endif

  assign _norm      = _raw | downcase
  assign _filters   = _norm | split: ','
  assign _filter_on = false
  for f in _filters
    assign f2 = f | strip | downcase
    if f2 != blank and f2 != 'all'
      assign _filter_on = true
    endif
  endfor

  assign _list      = blank
  assign _list_size = 0
  assign _source    = 'none'

  if _svc and _svc.testimonials_list
    assign _list = _svc.testimonials_list
    assign _list_size = _list | size
    assign _source = 'service.direct'
  endif

  if _list_size == 0 and _svc and _svc.testimonials_list and _svc.testimonials_list.value
    assign _list = _svc.testimonials_list.value
    assign _list_size = _list | size
    assign _source = 'service.value'
  endif

  if _list_size == 0 and _svc and _svc.testimonials_list and _svc.testimonials_list.values
    assign _list = _svc.testimonials_list.values
    assign _list_size = _list | size
    assign _source = 'service.values'
  endif

  if _list_size == 0
    assign _collection = shop.metaobjects['nb_testimonial']
    if _collection and _collection.values
      assign _list = _collection.values
      assign _list_size = _list | size
      assign _source = 'global.bracket'
    endif
  endif

  if _list_size == 0 and shop.metaobjects.nb_testimonial and shop.metaobjects.nb_testimonial.values
    assign _list = shop.metaobjects.nb_testimonial.values
    assign _list_size = _list | size
    assign _source = 'global.dot'
  endif
-%}

{%- assign _count = 0 -%}
{%- capture _cards -%}
  {%- if _list_size > 0 -%}
    {%- for entry in _list -%}
      {%- liquid
        assign include = true
        if _filter_on
          assign include = false
          if entry.tags
            for tag in entry.tags
              assign lt = tag | downcase
              for f in _filters
                assign f2 = f | strip | downcase
                if f2 != '' and f2 != 'all' and lt contains f2
                  assign include = true
                endif
              endfor
            endfor
          endif
        endif
      -%}
      {%- if include and _count < _limit -%}
        {%- assign _count = _count | plus: 1 -%}
        {% render 'nb-testimonial-card',
          quote: entry.quote,
          name: entry.name | default: '',
          title: entry.title | default: '',
          location: entry.location | default: '',
          avatar: entry.avatar,
          tags: entry.tags | join: ',' | default: '' %}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
{%- endcapture -%}

<style>
  .nb-service-tbelt{ margin-block: clamp(16px,3vw,28px); }
  .nb-service-tbelt__head{ margin: 0 0 clamp(10px,1.6vw,14px); }
  .nb-service-tbelt__grid{
    display:grid; gap:16px;
    grid-template-columns: repeat(2, minmax(0,1fr));
  }
  @media (max-width: 900px){ .nb-service-tbelt__grid{ grid-template-columns:1fr; } }
  .nb-service-tbelt__debug{ font-size:.85rem; opacity:.7; margin:8px 0 0; }
</style>

<section class="nb-service-tbelt"
         data-source="{{ _source }}"
         data-list-size="{{ _list_size }}"
         data-rendered="{{ _count }}"
         data-filter-on="{{ _filter_on }}"
         data-filter-raw="{{ _raw }}">
  <div class="nb-shell">
    {%- if _heading != blank and _heading != '-' -%}
      <h3 class="nb-h3 nb-service-tbelt__head">{{ _heading }}</h3>
    {%- endif -%}

    {%- if _count > 0 -%}
      <div class="nb-service-tbelt__grid">{{ _cards }}</div>
    {%- else -%}
      <div class="nb-service-tbelt__debug">
        Source=<strong>{{ _source }}</strong>,
        list.size=<strong>{{ _list_size }}</strong>,
        rendered=<strong>{{ _count }}</strong>,
        filter_on=<strong>{{ _filter_on }}</strong>,
        filter="<strong>{{ _raw }}</strong>"
      </div>
    {%- endif -%}
  </div>
</section>

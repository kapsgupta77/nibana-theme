{%- comment -%}
Service-page testimonials belt â€” robust (size-blind) + diagnostics.
Source priority (we try each until at least 1 card renders):
1) service.testimonials_list         (direct)
2) service.testimonials_list.value
3) service.testimonials_list.values
4) shop.metaobjects[...] (global fallback)
Filter: param tag_filter OR service.testimonials_tag_filter; "All" disables.
Limit: `limit` param (default 4)
{%- endcomment -%}

{%- liquid
  assign _heading = heading | default: 'What clients say'
  assign _limit   = limit   | default: 4
  assign _svc     = service

  assign _raw = tag_filter
  if _raw == blank and _svc
    assign _raw = _svc.testimonials_tag_filter
  endif
  if _raw == blank
    assign _raw = 'All'
  endif

  assign _norm      = _raw | downcase
  assign _filters   = _norm | split: ','
  assign _filter_on = false
  for f in _filters
    assign f2 = f | strip | downcase
    if f2 != blank and f2 != 'all'
      assign _filter_on = true
    endif
  endfor

  assign _count         = 0
  assign _used_source   = 'none'
  assign _last_list_sz  = 0
-%}

{%- capture _cards -%}
  {%- comment -%} 1) service.direct {%- endcomment -%}
  {%- if _count == 0 and _svc and _svc.testimonials_list -%}
    {%- assign _tmp = _svc.testimonials_list -%}
    {%- assign _last_list_sz = _tmp | size -%}
    {%- for entry in _tmp -%}
      {%- liquid
        assign include = true
        if _filter_on
          assign include = false
          if entry.tags
            for tag in entry.tags
              assign lt = tag | downcase
              for f in _filters
                assign f2 = f | strip | downcase
                if f2 != '' and f2 != 'all' and lt contains f2
                  assign include = true
                endif
              endfor
            endfor
          endif
        endif
      -%}
      {%- if include and _count < _limit -%}
        {%- assign _count = _count | plus: 1 -%}
        {% render 'nb-testimonial-card',
          quote: entry.quote, name: entry.name | default: '',
          title: entry.title | default: '', location: entry.location | default: '',
          avatar: entry.avatar, tags: entry.tags | join: ',' | default: '' %}
      {%- endif -%}
    {%- endfor -%}
    {%- if _count > 0 -%}{%- assign _used_source = 'service.direct' -%}{%- endif -%}
  {%- endif -%}

  {%- comment -%} 2) service.value {%- endcomment -%}
  {%- if _count == 0 and _svc and _svc.testimonials_list and _svc.testimonials_list.value -%}
    {%- assign _tmp = _svc.testimonials_list.value -%}
    {%- assign _last_list_sz = _tmp | size -%}
    {%- for entry in _tmp -%}
      {%- liquid
        assign include = true
        if _filter_on
          assign include = false
          if entry.tags
            for tag in entry.tags
              assign lt = tag | downcase
              for f in _filters
                assign f2 = f | strip | downcase
                if f2 != '' and f2 != 'all' and lt contains f2
                  assign include = true
                endif
              endfor
            endfor
          endif
        endif
      -%}
      {%- if include and _count < _limit -%}
        {%- assign _count = _count | plus: 1 -%}
        {% render 'nb-testimonial-card',
          quote: entry.quote, name: entry.name | default: '',
          title: entry.title | default: '', location: entry.location | default: '',
          avatar: entry.avatar, tags: entry.tags | join: ',' | default: '' %}
      {%- endif -%}
    {%- endfor -%}
    {%- if _count > 0 -%}{%- assign _used_source = 'service.value' -%}{%- endif -%}
  {%- endif -%}

  {%- comment -%} 3) service.values {%- endcomment -%}
  {%- if _count == 0 and _svc and _svc.testimonials_list and _svc.testimonials_list.values -%}
    {%- assign _tmp = _svc.testimonials_list.values -%}
    {%- assign _last_list_sz = _tmp | size -%}
    {%- for entry in _tmp -%}
      {%- liquid
        assign include = true
        if _filter_on
          assign include = false
          if entry.tags
            for tag in entry.tags
              assign lt = tag | downcase
              for f in _filters
                assign f2 = f | strip | downcase
                if f2 != '' and f2 != 'all' and lt contains f2
                  assign include = true
                endif
              endfor
            endfor
          endif
        endif
      -%}
      {%- if include and _count < _limit -%}
        {%- assign _count = _count | plus: 1 -%}
        {% render 'nb-testimonial-card',
          quote: entry.quote, name: entry.name | default: '',
          title: entry.title | default: '', location: entry.location | default: '',
          avatar: entry.avatar, tags: entry.tags | join: ',' | default: '' %}
      {%- endif -%}
    {%- endfor -%}
    {%- if _count > 0 -%}{%- assign _used_source = 'service.values' -%}{%- endif -%}
  {%- endif -%}

  {%- comment -%} 4) global.bracket {%- endcomment -%}
  {%- if _count == 0 -%}
    {%- assign _collection = shop.metaobjects['nb_testimonial'] -%}
    {%- if _collection and _collection.values -%}
      {%- assign _tmp = _collection.values -%}
      {%- assign _last_list_sz = _tmp | size -%}
      {%- for entry in _tmp -%}
        {%- liquid
          assign include = true
          if _filter_on
            assign include = false
            if entry.tags
              for tag in entry.tags
                assign lt = tag | downcase
                for f in _filters
                  assign f2 = f | strip | downcase
                  if f2 != '' and f2 != 'all' and lt contains f2
                    assign include = true
                  endif
                endfor
              endfor
            endif
          endif
        -%}
        {%- if include and _count < _limit -%}
          {%- assign _count = _count | plus: 1 -%}
          {% render 'nb-testimonial-card',
            quote: entry.quote, name: entry.name | default: '',
            title: entry.title | default: '', location: entry.location | default: '',
            avatar: entry.avatar, tags: entry.tags | join: ',' | default: '' %}
        {%- endif -%}
      {%- endfor -%}
      {%- if _count > 0 -%}{%- assign _used_source = 'global.bracket' -%}{%- endif -%}
    {%- endif -%}
  {%- endif -%}

  {%- comment -%} 5) global.dot {%- endcomment -%}
  {%- if _count == 0 and shop.metaobjects.nb_testimonial and shop.metaobjects.nb_testimonial.values -%}
    {%- assign _tmp = shop.metaobjects.nb_testimonial.values -%}
    {%- assign _last_list_sz = _tmp | size -%}
    {%- for entry in _tmp -%}
      {%- liquid
        assign include = true
        if _filter_on
          assign include = false
          if entry.tags
            for tag in entry.tags
              assign lt = tag | downcase
              for f in _filters
                assign f2 = f | strip | downcase
                if f2 != '' and f2 != 'all' and lt contains f2
                  assign include = true
                endif
              endfor
            endfor
          endif
        endif
      -%}
      {%- if include and _count < _limit -%}
        {%- assign _count = _count | plus: 1 -%}
        {% render 'nb-testimonial-card',
          quote: entry.quote, name: entry.name | default: '',
          title: entry.title | default: '', location: entry.location | default: '',
          avatar: entry.avatar, tags: entry.tags | join: ',' | default: '' %}
      {%- endif -%}
    {%- endfor -%}
    {%- if _count > 0 -%}{%- assign _used_source = 'global.dot' -%}{%- endif -%}
  {%- endif -%}
{%- endcapture -%}

<style>
  .nb-service-tbelt{ margin-block: clamp(16px,3vw,28px); }
  .nb-service-tbelt__head{ margin: 0 0 clamp(10px,1.6vw,14px); }
  .nb-service-tbelt__grid{ display:grid; gap:16px; grid-template-columns: repeat(2, minmax(0,1fr)); }
  @media (max-width: 900px){ .nb-service-tbelt__grid{ grid-template-columns:1fr; } }
  .nb-service-tbelt__debug{ font-size:.85rem; opacity:.7; margin:8px 0 0; }
  .nb-service-tbelt__debug code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
</style>

<section class="nb-service-tbelt"
  data-source="{{ _used_source }}"
  data-last-size="{{ _last_list_sz }}"
  data-rendered="{{ _count }}"
  data-filter-on="{{ _filter_on }}"
  data-filter-raw="{{ _raw }}">
  <div class="nb-shell">
    <h3 class="nb-h3 nb-service-tbelt__head">{{ _heading }}</h3>
    {%- if _count > 0 -%}
      <div class="nb-service-tbelt__grid">{{ _cards }}</div>
    {%- else -%}
      <div class="nb-service-tbelt__debug">
        <!-- DEBUG -->
        Source=<strong>{{ _used_source }}</strong>,
        last.size=<strong>{{ _last_list_sz }}</strong>,
        rendered=<strong>{{ _count }}</strong>,
        filter_on=<strong>{{ _filter_on }}</strong>,
        filter="<strong>{{ _raw }}</strong>"
      </div>
    {%- endif -%}
  </div>
</section>



{% capture title %}
  {% content_for 'block', id: 'heading', type: '_heading', text: article.title %}
{% endcapture %}

{% capture details %}
  {% content_for 'block',
    id: 'blog-post-details',
    type: '_blog-post-info-text',
    alignment: block.settings.alignment,
    article: article
  %}
{% endcapture %}

{% capture description %}
  {% content_for 'block', id: 'content', type: '_blog-post-description', article: article %}
{% endcapture %}

{%- comment -%} Attach category & subtopics from metafields with tag fallback {%- endcomment -%}
{%- assign cat = article.metafields.custom.primary_category | default: '' -%}
{%- assign topics_metafield = article.metafields.custom.subtopics -%}
{%- assign topics = '' -%}
{%- if topics_metafield != blank -%}
  {%- if topics_metafield.value -%}
    {%- assign topics = topics_metafield.value -%}
  {%- else -%}
    {%- assign topics = topics_metafield -%}
  {%- endif -%}
{%- endif -%}

{%- assign cat_fallback = '' -%}
{%- if cat == '' and article.tags -%}
  {%- comment -%} Find a tag that exactly matches one of our known categories (case-insensitive) {%- endcomment -%}
  {%- assign known = "Men’s Work|Relationships|Emotional Intelligence|Leadership|Embodiment|Sexuality|Self-Discovery" | split: "|" -%}
  {%- for t in article.tags -%}
    {%- assign t_down = t | downcase -%}
    {%- for k in known -%}
      {%- assign k_down = k | downcase -%}
      {%- if t_down == k_down -%}{%- assign cat_fallback = t -%}{%- break -%}{%- endif -%}
    {%- endfor -%}
    {%- if cat_fallback != '' -%}{%- break -%}{%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- assign cat_final = cat | default: cat_fallback -%}

{%- comment -%} Build subtopic string (comma-separated); if metafield blank, fallback to tags (excluding category) {%- endcomment -%}
{%- assign topics_joined = '' -%}
{%- if topics != '' -%}
  {%- assign topics_joined = topics | join: ',' -%}
{%- else -%}
  {%- assign topic_tags = '' -%}
  {%- for t in article.tags -%}
    {%- if t != cat_final and t != '' -%}
      {%- capture topic_tags -%}{{ topic_tags }}{%- if topic_tags != '' -%},{%- endif -%}{{ t }}{%- endcapture -%}
    {%- endif -%}
  {%- endfor -%}
  {%- assign topics_joined = topic_tags -%}
{%- endif -%}

<div
  class="blog-post-card"
  style="--text-align: {{ block.settings.alignment }}"
  data-cat="{{ cat_final | escape }}"
  data-topics="{{ topics_joined | escape }}"
>
  {%- if article.image -%}
    <div class="blog-post-card__image-container">
      <a href="{{ article.url }}">
        {% content_for 'block', id: 'image', type: '_blog-post-image', image: article.image %}
      </a>
    </div>
  {%- endif -%}

    <div class="blog-post-card__content">
    <a href="{{ article.url }}">{{ title }}</a>

    {%- liquid
      assign _w = article.content | strip_html | split: ' ' | size
      assign _m = _w | divided_by: 200
      assign _r = _w | modulo: 200
      if _r > 0
        assign _m = _m | plus: 1
      endif
      if _m < 1
        assign _m = 1
      endif
    -%}

    <div class="blog-post-card__meta">
      {{ details }}
      <span class="blog-post-card__sep" aria-hidden="true">·</span>
      <span class="blog-post-card__read">{{ _m }} min read</span>
    </div>

    {{ description }}
  </div>
</div>

{% stylesheet %}
  .blog-post-card {
    display: flex;
    flex-direction: column;
    text-align: var(--text-align);
  }

  .blog-post-item .blog-post-card__image-container,
  .blog-post-item .blog-post-card__content {
    width: 100%;
  }

  .blog-post-item:first-child .blog-post-card {
    flex-direction: row;

    @media screen and (max-width: 749px) {
      flex-direction: column;
    }
  }

  .blog-post-item:first-child .blog-post-card__image-container {
    width: 70%;

    @media screen and (max-width: 749px) {
      width: 100%;
    }
  }

  .blog-post-item:first-child:has(.blog-post-card__image-container) .blog-post-card__content {
    padding-inline-start: var(--columns-gap);
    width: 30%;

    @media screen and (max-width: 749px) {
      padding-inline-start: 0;
      width: 100%;
    }
  }

  .blog-post-card__content {
    padding-block-start: 0.4rem;
    display: flex;
    flex-direction: column;
  }

  .blog-post-card__content a {
    display: block;
    text-wrap: pretty;
    text-decoration: none;
    padding-block-start: 0.75rem;
  }

  .blog-post-card__content a:hover,
  .blog-post-card__content a:hover [style*='--color: var(--color-primary)'] {
    color: var(--color-primary-hover);
  }

  .blog-post-card__content a:hover [style*='--color: var(--color-foreground-heading)'] {
    color: rgb(var(--color-foreground-heading-rgb) / var(--opacity-subdued-text));
  }

  .blog-post-card__content a:hover [style*='--color: var(--color-foreground)'] {
    color: rgb(var(--color-foreground-rgb) / var(--opacity-subdued-text));
  }

  /* Blog micro-upgrade: reading minutes on cards */
  .blog-post-card__meta { color: rgb(var(--color-foreground-rgb) / var(--opacity-subdued-text)); font-size: var(--font-size--body-sm); }
  .blog-post-card__meta > * { display: inline; margin: 0; }
  .blog-post-card__sep { margin: 0 .4em; }

{% endstylesheet %}

{% schema %}
{
  "name": "t:names.blog_post",
  "settings": [
    {
      "type": "text_alignment",
      "id": "alignment",
      "label": "t:settings.alignment",
      "default": "left"
    }
  ]
}
{% endschema %}
